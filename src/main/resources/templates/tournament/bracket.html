<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}" lang="ko">
<head>
    <meta charset="UTF-8">
    <title th:text="${tournament.title} + ' - ëŒ€ì§„í‘œ'">ëŒ€ì§„í‘œ</title>

    <th:block layout:fragment="css">
        <style>
            /* â”€â”€ íˆì–´ë¡œ í—¤ë” (list/detail í†µì¼) â”€â”€ */
            .bracket-hero {
                background: linear-gradient(135deg, var(--primary-color, #0056b3) 0%, var(--primary-dark, #003d82) 100%);
                color: #fff;
                padding: 2.2rem 0 1.8rem;
                margin-bottom: 2rem;
                border-radius: 0 0 20px 20px;
            }
            [data-theme="dark"] .bracket-hero {
                background: linear-gradient(135deg, #0a1628 0%, #0d2244 100%);
            }
            .bracket-hero h1 { font-size: clamp(1.4rem, 3vw, 2rem); font-weight: 900; letter-spacing: -0.02em; margin-bottom: 0.5rem; }
            .bracket-hero .breadcrumb { opacity: 0.65; font-size: 0.82rem; margin-bottom: 0; }
            .bracket-hero .breadcrumb-item + .breadcrumb-item::before { color: rgba(255,255,255,0.35); }
            .bracket-hero-meta { display: flex; align-items: center; gap: 1rem; flex-wrap: wrap; margin-top: 0.8rem; }
            .bracket-hero-meta .badge-status {
                background: rgba(255,255,255,0.18); backdrop-filter: blur(4px);
                color: #fff; padding: 0.3rem 0.9rem; border-radius: 20px; font-size: 0.82rem; font-weight: 600;
            }
            .bracket-hero-meta .meta-text { opacity: 0.75; font-size: 0.85rem; }

            /* â”€â”€ ë©”ì¸ ì»¨í…Œì´ë„ˆ â”€â”€ */
            .bracket-container {
                background: var(--bg-white);
                border-radius: var(--radius-lg, 16px);
                box-shadow: var(--shadow-md);
                overflow: hidden;
            }

            /* â”€â”€ íƒ­ â”€â”€ */
            .bracket-tabs {
                display: flex;
                background: var(--bg-light);
                border-bottom: 3px solid var(--border-color);
            }
            .bracket-tab {
                flex: 1; padding: 1.1rem 2rem; text-align: center;
                font-size: 1rem; font-weight: 700;
                color: var(--text-secondary); background: transparent; border: none;
                cursor: pointer; transition: var(--transition);
                border-right: 1px solid var(--border-color);
            }
            .bracket-tab:last-child { border-right: none; }
            .bracket-tab:hover { background: var(--bg-white); color: var(--text-primary); }
            .bracket-tab.active {
                background: var(--bg-white);
                color: var(--primary-color);
                border-bottom: 3px solid var(--primary-color);
                margin-bottom: -3px;
            }

            .tab-content { display: none; padding: 2rem; }
            .tab-content.active { display: block; }

            /* â”€â”€ ì˜ˆì„  â”€â”€ */
            .qualifier-layout { display: flex; gap: 2rem; }
            .group-list { width: 280px; flex-shrink: 0; }

            .group-item {
                background: var(--bg-white);
                border: 1.5px solid var(--border-color);
                border-radius: var(--radius-md, 12px);
                padding: 1.2rem; margin-bottom: 1rem;
                cursor: pointer; transition: var(--transition);
            }
            .group-item:hover {
                border-color: var(--primary-color);
                box-shadow: 0 4px 14px rgba(0,102,204,0.15);
                transform: translateX(4px);
            }
            .group-item.active {
                border-color: var(--primary-color);
                background: rgba(0,102,204,0.06);
                box-shadow: 0 4px 14px rgba(0,102,204,0.18);
            }
            [data-theme="dark"] .group-item.active { background: rgba(77,148,255,0.08); }

            .group-name {
                font-size: 1rem; font-weight: 700;
                color: var(--text-primary); margin-bottom: 0.8rem;
                display: flex; align-items: center; gap: 0.5rem;
            }
            .group-badge {
                display: inline-block; padding: 0.3rem 0.8rem;
                background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
                color: white; border-radius: 20px; font-size: 0.82rem; font-weight: 700;
            }
            .seed-list { list-style: none; padding: 0; margin: 0; }
            .seed-item {
                padding: 0.4rem 0; font-size: 0.88rem; color: var(--text-secondary);
                display: flex; align-items: center; gap: 0.5rem;
            }
            .seed-number {
                display: inline-flex; align-items: center; justify-content: center;
                width: 22px; height: 22px; background: var(--bg-light); border-radius: 50%;
                font-size: 0.72rem; font-weight: 700; color: var(--text-secondary); flex-shrink: 0;
            }
            .seed-item.winner .seed-number { background: #c41e3a; color: white; }
            .seed-item.winner { font-weight: 700; color: #c41e3a; }

            .bracket-display {
                flex: 1; min-height: 600px;
                background: var(--bg-light);
                border-radius: var(--radius-md, 12px); padding: 2rem;
            }

            /* â”€â”€ ë¡œë”© / ë¹ˆ ìƒíƒœ â”€â”€ */
            .loading-spinner { text-align: center; padding: 5rem 2rem; }
            .spinner {
                border: 4px solid var(--border-color);
                border-top: 4px solid var(--primary-color);
                border-radius: 50%; width: 48px; height: 48px;
                animation: spin 1s linear infinite; margin: 0 auto 1rem;
            }
            @keyframes spin { 100% { transform: rotate(360deg); } }
            .empty-state { text-align: center; padding: 5rem 2rem; color: var(--text-secondary); }
            .empty-state i { font-size: 3.5rem; opacity: 0.25; margin-bottom: 1rem; display: block; }

            @media (max-width: 992px) {
                .qualifier-layout { flex-direction: column; }
                .group-list { width: 100%; }
            }

            /* â”€â”€ ì¡°ë³„ ê²½ê¸° ì¹´ë“œ â”€â”€ */
            .group-matches { padding: 2rem; }
            .matches-list { display: grid; gap: 1rem; }

            .match-item {
                background: var(--bg-white);
                border: 1.5px solid var(--border-color);
                border-radius: var(--radius-md, 12px);
                padding: 1.2rem; transition: var(--transition);
            }
            .match-item:hover {
                border-color: var(--primary-color);
                box-shadow: 0 4px 14px rgba(0,102,204,0.12);
                transform: translateY(-2px);
            }
            .match-item.completed { opacity: 0.9; }
            .match-header {
                display: flex; justify-content: space-between; align-items: center;
                margin-bottom: 1rem; padding-bottom: 0.75rem;
                border-bottom: 1px solid var(--border-color);
            }
            .match-number { font-weight: 700; color: var(--text-secondary); font-size: 0.85rem; }
            .match-players { display: flex; justify-content: space-between; align-items: center; gap: 1rem; }
            .match-players .player {
                flex: 1; display: flex; justify-content: space-between; align-items: center;
                padding: 0.75rem 1rem;
                background: var(--bg-light);
                border-radius: var(--radius-sm, 8px); border: 1.5px solid transparent;
            }
            .match-players .player.winner {
                background: rgba(10,98,48,0.08); border-color: #0a6230; font-weight: 700;
            }
            [data-theme="dark"] .match-players .player.winner {
                background: rgba(39,174,96,0.12); border-color: #27ae60;
            }
            .match-players .player-name { font-size: 0.95rem; color: var(--text-primary); }
            .match-players .player-score { font-size: 1.15rem; font-weight: 700; color: var(--text-secondary); }
            .match-players .vs { font-weight: 800; color: var(--text-secondary); font-size: 0.85rem; padding: 0 0.3rem; }

            /* â”€â”€ ë³¸ì„  ë¸Œë˜í‚· â”€â”€ */
            .bracket-wrapper {
                position: relative; overflow: auto; padding: 1rem;
                background: var(--bg-light); border-radius: var(--radius-md, 12px);
            }
            .bracket-stage {
                position: relative; min-height: 600px;
                display: inline-flex; justify-content: center; align-items: flex-start;
                padding: 1rem; width: 100%;
            }

            @media (max-width: 1800px) { #mainBracket { transform: scale(0.9); transform-origin: center top; } }
            @media (max-width: 1600px) { #mainBracket { transform: scale(0.8); transform-origin: center top; } }
            @media (max-width: 1400px) { #mainBracket { transform: scale(0.7); transform-origin: center top; } }
            @media (max-width: 1200px) { #mainBracket { transform: scale(0.6); transform-origin: center top; } }

            #mainBracket {
                display: flex; gap: 2rem; justify-content: center; position: relative;
                min-width: fit-content; flex-shrink: 0; transition: transform 0.3s ease;
            }
            .bracket-side { display: flex; gap: 1.8rem; }
            .round { display: flex; flex-direction: column; min-width: 160px; position: relative; }

            .round-header {
                text-align: center; font-size: 0.88rem; font-weight: 800;
                color: var(--primary-color);
                padding: 0.5rem 0.8rem;
                background: var(--bg-white);
                border: 1.5px solid var(--border-color);
                border-radius: var(--radius-sm, 8px);
                margin-bottom: 1rem; box-shadow: var(--shadow-sm); white-space: nowrap;
            }
            .round-matches { display: flex; flex-direction: column; justify-content: space-around; flex: 1; gap: 1rem; }

            .match {
                width: 150px;
                background: var(--bg-white);
                border: 1.5px solid var(--border-color);
                border-radius: 8px; overflow: hidden;
                box-shadow: var(--shadow-sm); transition: var(--transition-fast); margin: 4px 0;
            }
            .match:hover {
                transform: translateY(-2px); border-color: var(--primary-color);
                box-shadow: 0 4px 12px rgba(0,102,204,0.18);
            }
            .match-row {
                display: flex; justify-content: space-between; align-items: center;
                padding: 0.4rem 0.6rem;
                border-bottom: 1px solid var(--border-color); min-height: 28px;
            }
            .match-row:last-child { border-bottom: none; }
            :root .match-row.winner { background: #fff0f0; font-weight: 700; }
            [data-theme="dark"] .match-row.winner { background: rgba(220,53,69,0.18); font-weight: 700; }

            .player-name {
                font-size: 0.8rem; color: var(--text-primary);
                white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 95px;
            }
            .match-row.winner .player-name { font-weight: 700; color: #dc3545; }
            .player-score { font-size: 0.88rem; font-weight: 700; color: var(--text-secondary); min-width: 22px; text-align: center; }
            .match-row.winner .player-score { color: #dc3545; }

            .final-round {
                display: flex; flex-direction: column;
                justify-content: center; align-items: center; min-width: 220px;
            }
            .final-round .round-header {
                font-size: 1.05rem; color: #dc3545;
                background: var(--bg-white);
                border: 2px solid #dc3545;
                box-shadow: 0 4px 14px rgba(220,53,69,0.22);
            }
            .final-round .match { width: 170px; border: 2px solid #dc3545; }

            #svg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 0; }
            .round, .final-round { position: relative; z-index: 1; }
        </style>
    </th:block>
</head>

<body>
<div layout:fragment="content">

    <!-- â”€â”€ íˆì–´ë¡œ í—¤ë” â”€â”€ -->
    <div class="bracket-hero">
        <div class="container">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-2">
                    <li class="breadcrumb-item"><a th:href="@{/tournament/list}" class="text-white-50">ëŒ€íšŒ</a></li>
                    <li class="breadcrumb-item"><a th:href="@{/tournament/detail/{id}(id=${tournament.id})}" class="text-white-50" th:text="${tournament.title}">ëŒ€íšŒëª…</a></li>
                    <li class="breadcrumb-item active text-white">ëŒ€ì§„í‘œ</li>
                </ol>
            </nav>
            <h1><i class="bi bi-diagram-3-fill me-2"></i><span th:text="${tournament.title}">ëŒ€íšŒëª…</span> ëŒ€ì§„í‘œ</h1>
            <div class="bracket-hero-meta">
                <span class="badge-status" th:text="${tournament.status.description}">ì§„í–‰ì¤‘</span>
                <span class="meta-text" th:if="${tournament.startDate != null}">
                    <i class="bi bi-calendar3 me-1"></i>
                    <span th:text="${#temporals.format(tournament.startDate,'yyyy.MM.dd')}"></span>
                    ~ <span th:text="${#temporals.format(tournament.endDate,'yyyy.MM.dd')}"></span>
                </span>
            </div>
        </div>
    </div>

    <div class="container-fluid px-3 px-md-4 pb-5">
        <div class="bracket-container">
            <div class="bracket-tabs">
                <button class="bracket-tab active" data-tab="qualifier" onclick="switchTab('qualifier')">
                    <i class="bi bi-grid-3x3-gap me-2"></i>ì˜ˆì„ 
                </button>
                <button class="bracket-tab" data-tab="final" onclick="switchTab('final')">
                    <i class="bi bi-trophy me-2"></i>ë³¸ì„ 
                </button>
            </div>

            <div id="qualifier-content" class="tab-content active">
                <div class="qualifier-layout">
                    <div class="group-list" id="groupList">
                        <div class="loading-spinner">
                            <div class="spinner"></div>
                            <p class="text-muted small mt-2">ì¡° í¸ì„±ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                        </div>
                    </div>
                    <div class="bracket-display" id="groupBracket">
                        <div class="empty-state">
                            <i class="bi bi-arrow-left-circle"></i>
                            <h5>ì¢Œì¸¡ì—ì„œ ì¡°ë¥¼ ì„ íƒí•˜ì„¸ìš”</h5>
                            <p class="text-muted small">ì„ íƒí•œ ì¡°ì˜ ëŒ€ì§„í‘œê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤</p>
                        </div>
                    </div>
                </div>
            </div>

            <div id="final-content" class="tab-content">
                <div class="bracket-wrapper">
                    <div class="bracket-stage">
                        <svg id="svg"></svg>
                        <div id="mainBracket">
                            <div class="loading-spinner">
                                <div class="spinner"></div>
                                <p class="text-muted small mt-2">ë³¸ì„  ëŒ€ì§„í‘œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="text-center mt-4">
            <a th:href="@{/tournament/detail/{id}(id=${tournament.id})}"
               class="btn btn-outline-secondary rounded-pill px-4">
                <i class="bi bi-arrow-left me-2"></i>ëŒ€íšŒ ìƒì„¸ë¡œ ëŒì•„ê°€ê¸°
            </a>
        </div>
    </div>

</div>

<th:block layout:fragment="script">
    <script th:inline="javascript">
        const TOURNAMENT_ID = /*[[${tournament.id}]]*/ 1;

        function switchTab(tabName) {
            document.querySelectorAll('.bracket-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(`${tabName}-content`).classList.add('active');
            if (tabName === 'qualifier') loadQualifierGroups();
            else if (tabName === 'final') loadMainBracket();
        }

        document.addEventListener('DOMContentLoaded', function() {
            loadQualifierGroups();
        });

        // â”€â”€â”€ ì˜ˆì„  â”€â”€â”€
        function loadQualifierGroups() {
            const groupListDiv = document.getElementById('groupList');

            $.ajax({
                url: `/tournament/groupBrackets/${TOURNAMENT_ID}`,
                method: 'GET',
                success: function(response) {
                    if (!response || response.length === 0) {
                        groupListDiv.innerHTML = `<div class="empty-state p-4"><i class="bi bi-inbox"></i><h5 class="mt-2">ìƒì„±ëœ ì¡°ê°€ ì—†ìŠµë‹ˆë‹¤</h5><p class="text-muted small">ëŒ€ì§„í‘œë¥¼ ë¨¼ì € ìƒì„±í•´ ì£¼ì„¸ìš”.</p></div>`;
                        return;
                    }
                    let html = '';
                    response.forEach((group, index) => {
                        const isActive = index === 0 ? 'active' : '';
                        html += `
                            <div class="group-item ${isActive}" onclick="selectGroup(${group.id}, this)">
                                <div class="group-name"><span class="group-badge">${group.groupName}</span></div>
                                <ul class="seed-list">
                                    ${group.seeds ? group.seeds.map(seed => `
                                        <li class="seed-item ${seed.isWinner ? 'winner' : ''}">
                                            <span class="seed-number">${seed.seedNumber}</span>
                                            <span>${seed.playerName || 'BYE'}</span>
                                        </li>
                                    `).join('') : ''}
                                </ul>
                            </div>`;
                    });
                    groupListDiv.innerHTML = html;
                    if (response.length > 0) loadGroupBracket(response[0].id);
                },
                error: function() {
                    groupListDiv.innerHTML = `<div class="alert alert-danger m-3"><i class="bi bi-exclamation-triangle me-2"></i>ì¡° ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤</div>`;
                }
            });
        }

        function selectGroup(groupId, element) {
            document.querySelectorAll('.group-item').forEach(item => item.classList.remove('active'));
            element.classList.add('active');
            loadGroupBracket(groupId);
        }

        function loadGroupBracket(groupId) {
            const bracketDiv = document.getElementById('groupBracket');
            bracketDiv.innerHTML = `<div class="loading-spinner"><div class="spinner"></div><p class="text-muted small mt-2">ëŒ€ì§„í‘œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p></div>`;

            $.ajax({
                url: `/tournament/groupMatches/${groupId}`,
                method: 'GET',
                success: function(response) {
                    if (!response.matches || response.matches.length === 0) {
                        bracketDiv.innerHTML = `<div class="empty-state"><i class="bi bi-calendar-x"></i><h5 class="mt-2">ê²½ê¸°ê°€ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤</h5></div>`;
                        return;
                    }
                    let html = `<div class="group-matches"><h5 class="fw-bold mb-4">${response.groupName} ê²½ê¸° ì¼ì • <span class="badge bg-secondary ms-1">${response.totalMatches}ê²½ê¸°</span></h5><div class="matches-list">`;
                    response.matches.forEach(match => {
                        const statusBadge = getStatusBadge(match.status);
                        const p1 = match.player1Name || 'BYE';
                        const p2 = match.player2Name || 'BYE';
                        const s1 = match.score1 !== null ? match.score1 : '-';
                        const s2 = match.score2 !== null ? match.score2 : '-';
                        const isCompleted = match.status === 'COMPLETED';
                        const winner = match.winner;
                        html += `
                            <div class="match-item ${isCompleted ? 'completed' : ''}">
                                <div class="match-header">
                                    <span class="match-number"><i class="bi bi-hash"></i>ê²½ê¸° ${match.matchNumber}</span>
                                    <span class="${statusBadge.class}">${statusBadge.text}</span>
                                </div>
                                <div class="match-players">
                                    <div class="player ${winner === p1 ? 'winner' : ''}">
                                        <span class="player-name">${p1}</span>
                                        <span class="player-score">${s1}</span>
                                    </div>
                                    <div class="vs">VS</div>
                                    <div class="player ${winner === p2 ? 'winner' : ''}">
                                        <span class="player-name">${p2}</span>
                                        <span class="player-score">${s2}</span>
                                    </div>
                                </div>
                            </div>`;
                    });
                    html += `</div></div>`;
                    bracketDiv.innerHTML = html;
                },
                error: function() {
                    bracketDiv.innerHTML = `<div class="alert alert-danger m-3"><i class="bi bi-exclamation-triangle me-2"></i>ì¡°ë³„ ê²½ê¸°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤</div>`;
                }
            });
        }

        function getStatusBadge(status) {
            const badges = {
                'SCHEDULED':   { class: 'badge bg-secondary', text: 'ì˜ˆì •' },
                'IN_PROGRESS': { class: 'badge bg-warning text-dark', text: 'ì§„í–‰ì¤‘' },
                'COMPLETED':   { class: 'badge bg-success', text: 'ì™„ë£Œ' },
                'CANCELLED':   { class: 'badge bg-danger', text: 'ì·¨ì†Œ' }
            };
            return badges[status] || { class: 'badge bg-secondary', text: status };
        }

        // â”€â”€â”€ ë³¸ì„  â”€â”€â”€
        let BRACKET_ROUNDS = [];
        let BRACKET_FINAL_INDEX = 0;

        function loadMainBracket() {
            const container = $('#mainBracket');
            $.ajax({
                url: `/tournament/mainBracket/${TOURNAMENT_ID}`,
                method: 'GET',
                success: function(matches) {
                    if (!matches || matches.length === 0) {
                        container.html(`<div class="empty-state"><i class="bi bi-trophy"></i><h5 class="mt-2">ë³¸ì„  ëŒ€ì§„í‘œê°€ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤</h5></div>`);
                        return;
                    }
                    renderMainBracket(matches);
                },
                error: function() {
                    container.html(`<div class="alert alert-danger m-3"><i class="bi bi-exclamation-triangle me-2"></i>ë³¸ì„  ëŒ€ì§„í‘œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤</div>`);
                }
            });
        }

        function renderMainBracket(matches) {
            const container = $('#mainBracket');
            container.empty();

            const roundMatches = {};
            matches.forEach(m => {
                const r = m.roundName || 'ê¸°íƒ€';
                if (!roundMatches[r]) roundMatches[r] = [];
                roundMatches[r].push(m);
            });
            Object.keys(roundMatches).forEach(round => {
                roundMatches[round].sort((a, b) => a.matchNumber - b.matchNumber);
            });

            const roundOrder = ['32ê°•', '16ê°•', '8ê°•', '4ê°•', 'ê²°ìŠ¹'];
            BRACKET_ROUNDS = roundOrder.filter(r => roundMatches[r]);
            BRACKET_FINAL_INDEX = BRACKET_ROUNDS.length - 1;

            if (BRACKET_ROUNDS.length === 0) {
                container.html('<div class="empty-state"><h5>ë³¸ì„  ì—†ìŒ</h5></div>');
                return;
            }

            const leftMatches = {}, rightMatches = {};
            ['32ê°•', '16ê°•', '8ê°•'].forEach(round => {
                if (roundMatches[round]) {
                    const half = Math.floor(roundMatches[round].length / 2);
                    leftMatches[round] = roundMatches[round].slice(0, half);
                    rightMatches[round] = roundMatches[round].slice(half);
                }
            });
            if (roundMatches['4ê°•']) {
                const semis = roundMatches['4ê°•'];
                const half = Math.floor(semis.length / 2);
                leftMatches['4ê°•'] = semis.slice(0, half || 1);
                rightMatches['4ê°•'] = semis.slice(half || 1);
            }

            const leftSide = $('<div class="bracket-side left"></div>');
            const rightSide = $('<div class="bracket-side right"></div>');
            const finalWrap = $('<div class="final-round"></div>');

            ['32ê°•', '16ê°•', '8ê°•', '4ê°•'].forEach(round => {
                if (leftMatches[round] && leftMatches[round].length > 0)
                    leftSide.append(makeRound(leftMatches[round], round, BRACKET_ROUNDS.indexOf(round), 'left'));
            });
            if (roundMatches['ê²°ìŠ¹'] && roundMatches['ê²°ìŠ¹'].length > 0)
                finalWrap.append(makeRound(roundMatches['ê²°ìŠ¹'], 'ğŸ† ê²°ìŠ¹', BRACKET_FINAL_INDEX, 'final'));
            ['4ê°•', '8ê°•', '16ê°•', '32ê°•'].forEach(round => {
                if (rightMatches[round] && rightMatches[round].length > 0)
                    rightSide.append(makeRound(rightMatches[round], round, BRACKET_ROUNDS.indexOf(round), 'right'));
            });

            container.append(leftSide).append(finalWrap).append(rightSide);
            setTimeout(drawLines, 100);
        }

        function makeRound(matches, title, roundIndex, branch) {
            const round = $(`<div class="round" data-round="${roundIndex}" data-branch="${branch}"></div>`);
            round.append(`<div class="round-header">${title}</div>`);
            const matchesWrap = $('<div class="round-matches"></div>');
            matches.forEach(m => matchesWrap.append(makeMatch(m)));
            round.append(matchesWrap);
            return round;
        }

        function makeMatch(m) {
            const p1 = m.player1Name || 'TBD', p2 = m.player2Name || 'TBD';
            const s1 = m.score1 ?? '', s2 = m.score2 ?? '', w = m.winner;
            const match = $('<div class="match"></div>');
            const row1 = $(`<div class="match-row ${w === p1 ? 'winner' : ''}"></div>`);
            const row2 = $(`<div class="match-row ${w === p2 ? 'winner' : ''}"></div>`);
            row1.append(`<div class="player-name">${p1}</div><div class="player-score">${s1}</div>`);
            row2.append(`<div class="player-name">${p2}</div><div class="player-score">${s2}</div>`);
            match.append(row1).append(row2);
            return match;
        }

        function drawLines() {
            const svgEl = document.getElementById('svg');
            if (!svgEl) return;
            svgEl.innerHTML = '';
            const stage = document.querySelector('.bracket-stage');
            if (!stage) return;
            const stageRect = stage.getBoundingClientRect();
            svgEl.setAttribute('width', stage.scrollWidth);
            svgEl.setAttribute('height', stage.scrollHeight);
            svgEl.setAttribute('viewBox', `0 0 ${stage.scrollWidth} ${stage.scrollHeight}`);

            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            const lineColor = isDark ? '#334466' : '#dee2e6';

            document.querySelectorAll('.round').forEach(round => {
                const roundIndex = parseInt(round.getAttribute('data-round'), 10);
                const branch = round.getAttribute('data-branch');
                if (!branch || branch === 'final') return;

                const targetSelector = (roundIndex + 1 === BRACKET_FINAL_INDEX)
                    ? `.round[data-round="${BRACKET_FINAL_INDEX}"][data-branch="final"]`
                    : `.round[data-round="${roundIndex + 1}"][data-branch="${branch}"]`;
                const targetRound = document.querySelector(targetSelector);
                if (!targetRound) return;

                round.querySelectorAll('.match').forEach((match, mi) => {
                    const nextMatch = targetRound.querySelectorAll('.match')[Math.floor(mi / 2)];
                    if (!nextMatch) return;
                    const mR = match.getBoundingClientRect();
                    const nR = nextMatch.getBoundingClientRect();
                    const y1 = mR.top - stageRect.top + stage.scrollTop + mR.height / 2;
                    const y2 = nR.top - stageRect.top + stage.scrollTop + nR.height / 2;
                    const x1 = mR.left - stageRect.left + stage.scrollLeft + mR.width;
                    const x2 = nR.left - stageRect.left + stage.scrollLeft;
                    const midX = (x1 + x2) / 2;
                    const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
                    path.setAttribute("d", `M ${x1} ${y1} L ${midX} ${y1} L ${midX} ${y2} L ${x2} ${y2}`);
                    path.setAttribute("fill", "none");
                    path.setAttribute("stroke", lineColor);
                    path.setAttribute("stroke-width", "2");
                    svgEl.appendChild(path);
                });
            });
        }

        $(window).on('resize', () => setTimeout(drawLines, 120));
        // ë‹¤í¬ëª¨ë“œ ì „í™˜ ì‹œ ì—°ê²°ì„  ìƒ‰ ì—…ë°ì´íŠ¸
        new MutationObserver(() => drawLines()).observe(document.documentElement, { attributes: true, attributeFilter: ['data-theme'] });
    </script>
</th:block>
</body>
</html>
