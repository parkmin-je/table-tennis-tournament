<!DOCTYPE html>
<html layout:decorate="~{layout}" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security" xmlns:th="http://www.thymeleaf.org">
<head>
    <title>ëŒ€íšŒ ìƒì„¸</title>

    <!-- â­â­â­ CSRF ë©”íƒ€ íƒœê·¸ ì§ì ‘ ì¶”ê°€ â­â­â­ -->
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>

    <th:block layout:fragment="css">
        <link rel="stylesheet" href="https://unpkg.com/jquery-bracket@0.11.1/dist/jquery.bracket.min.css">
        <style>
            /* app.cssì—ì„œ ê¸°ë³¸ bracket ìŠ¤íƒ€ì¼ì„ ì˜¤ë²„ë¼ì´ë“œí•©ë‹ˆë‹¤. */

            /* â­ Toast ì•Œë¦¼ ìŠ¤íƒ€ì¼ */
            #toast {
                visibility: hidden;
                min-width: 300px;
                background-color: #333;
                color: #fff;
                text-align: center;
                border-radius: 8px;
                padding: 16px;
                position: fixed;
                z-index: 9999;
                left: 50%;
                bottom: 30px;
                transform: translateX(-50%);
                font-size: 17px;
                opacity: 0;
                transition: opacity 0.5s, visibility 0.5s;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            }

            #toast.show {
                visibility: visible;
                opacity: 1;
            }

            /* â­â­â­ 3D íƒêµ¬ëŒ€ ìŠ¤íƒ€ì¼ â­â­â­ */
            .table-item {
                width: 80px;
                height: 120px;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                border-radius: 12px;
                cursor: pointer;
                transition: all 0.3s ease;
                position: relative;
                font-weight: bold;
                font-size: 20px;
                box-shadow: 0 4px 8px rgba(0,0,0,0.2);
                transform: perspective(1000px) rotateX(5deg);
            }

            /* ì‚¬ìš© ê°€ëŠ¥í•œ íƒêµ¬ëŒ€ (ì´ˆë¡ìƒ‰ 3D) */
            .table-item.available {
                background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                color: white;
                border: 3px solid #047857;
            }

            .table-item.available:hover {
                transform: perspective(1000px) rotateX(0deg) scale(1.1);
                box-shadow: 0 8px 20px rgba(16, 185, 129, 0.4);
                background: linear-gradient(135deg, #34d399 0%, #10b981 100%);
            }

            .table-item.available:active {
                transform: perspective(1000px) rotateX(5deg) scale(0.95);
            }

            /* ì‚¬ìš© ì¤‘ì¸ íƒêµ¬ëŒ€ (ë¹¨ê°„ìƒ‰ 3D) */
            .table-item.occupied {
                background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
                color: white;
                border: 3px solid #b91c1c;
                cursor: not-allowed;
                opacity: 0.8;
            }

            .table-item.occupied:hover {
                transform: perspective(1000px) rotateX(0deg) scale(1.05);
                box-shadow: 0 8px 20px rgba(239, 68, 68, 0.4);
            }

            /* íƒêµ¬ëŒ€ ë²ˆí˜¸ */
            .table-item::before {
                content: 'íƒêµ¬ëŒ€';
                font-size: 11px;
                font-weight: normal;
                opacity: 0.8;
                margin-bottom: 5px;
            }

            /* ê²½ê¸° ì •ë³´ (ì‘ì€ í…ìŠ¤íŠ¸) */
            .table-item .small-text {
                font-size: 9px;
                text-align: center;
                margin-top: 8px;
                line-height: 1.2;
                opacity: 0.9;
                max-width: 70px;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }

            /* íƒêµ¬ëŒ€ ê·¸ë¦¬ë“œ ë ˆì´ì•„ì›ƒ */
            #tableList {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
                gap: 20px;
                padding: 20px;
                justify-items: center;
            }

            /* ëª¨ë‹¬ ë°°ê²½ */
            .modal-body {
                background: white !important;
            }

            /* ëª¨ë‹¬ í—¤ë” */
            .modal-header {
                background: linear-gradient(135deg, #004E89 0%, #003A66 100%) !important;
                color: white !important;
                border-bottom: 3px solid #FF6B35 !important;
            }

            .modal-header .btn-close {
                filter: brightness(0) invert(1);
            }

            .modal-title {
                color: white !important;
                font-weight: 700 !important;
            }

            /* ëª¨ë‹¬ ì „ì²´ */
            .modal-content {
                border: 3px solid #FF6B35 !important;
                border-radius: 20px !important;
                box-shadow: 0 16px 48px rgba(0, 0, 0, 0.3) !important;
            }

            /* íƒêµ¬ëŒ€ ì„ íƒ ì•ˆë‚´ í…ìŠ¤íŠ¸ */
            #tableList::before {
                content: 'íƒêµ¬ëŒ€ë¥¼ ì„ íƒí•˜ì„¸ìš”';
                display: block;
                text-align: center;
                font-size: 1.2rem;
                font-weight: 700;
                color: #004E89;
                margin-bottom: 1rem;
                padding: 1rem;
                background: linear-gradient(90deg, rgba(255, 107, 53, 0.1), rgba(0, 168, 120, 0.1));
                border-radius: 12px;
            }
        </style>
    </th:block>
</head>
<body>
<div layout:fragment="content">
    <div class="container my-5">
        <div class="row">
            <div class="col-12 text-center mb-4">
                <h1 class="display-4 fw-bold mb-3" th:text="${tournament.title}">ëŒ€íšŒ ì œëª©</h1>
                <p class="lead text-muted mb-4" th:text="${tournament.description}">ëŒ€íšŒ ì„¤ëª…</p>
                <div class="d-flex justify-content-center flex-wrap gap-2 mb-4">
                    <!-- â­â­â­ ìˆ˜ì •: .name() ë©”ì„œë“œ ì‚¬ìš© â­â­â­ -->
                    <span th:classappend="${tournament.status.name() == 'READY' ? 'badge bg-secondary' :
                                            (tournament.status.name() == 'RECRUITING' ? 'badge bg-primary' :
                                            (tournament.status.name() == 'IN_PROGRESS' ? 'badge bg-warning text-dark' : 'badge bg-success'))}"
                          th:text="${tournament.status.description}" class="badge fs-6">ìƒíƒœ</span>
                    <span class="badge bg-dark fs-6" th:text="${tournament.type.description}">ìœ í˜•</span>
                </div>
            </div>

            <!-- ê´€ë¦¬ìë§Œ ë³¼ ìˆ˜ ìˆëŠ” ë²„íŠ¼ -->
            <div class="col-12 text-center mb-5" sec:authorize="hasAnyRole('ADMIN', 'MANAGER')">
                <!-- ì˜ˆì„  ëŒ€ì§„í‘œ ìƒì„± ë²„íŠ¼ -->
                <a href="javascript:void(0)"
                   th:data-tournament-id="${tournament.id}"
                   onclick="createPreliminary(this.dataset.tournamentId)"
                   class="btn btn-success btn-lg me-3 fw-bold">
                    <i class="bi bi-plus-circle me-2"></i>ì˜ˆì„  ëŒ€ì§„í‘œ ìƒì„±
                </a>

                <!-- ë³¸ì„  ëŒ€ì§„í‘œ ìƒì„± ë²„íŠ¼ -->
                <a href="javascript:void(0)"
                   th:data-tournament-id="${tournament.id}"
                   onclick="createMainBracket(this.dataset.tournamentId)"
                   class="btn btn-warning btn-lg me-3 fw-bold"
                   th:classappend="${isMainBracketGenerated ? 'disabled' : ''}">
                    <i class="bi bi-diagram-3 me-2"></i>ë³¸ì„  ëŒ€ì§„í‘œ ìƒì„±
                </a>

            </div>

            <!-- ëª¨ë“  ì‚¬ìš©ìê°€ ë³¼ ìˆ˜ ìˆëŠ” ë³¸ì„  ëŒ€ì§„í‘œ ë³´ê¸° ë²„íŠ¼ -->
            <div class="col-12 text-center mb-4" th:if="${isMainBracketGenerated}">
                <a th:href="@{/tournament/bracket/{id}(id=${tournament.id})}"
                   class="btn btn-info btn-lg fw-bold">
                    <i class="bi bi-bar-chart-line me-2"></i>ë³¸ì„  ëŒ€ì§„í‘œ ë³´ê¸°
                </a>
            </div>

            <!-- ì˜ˆì •ëœ ê²½ê¸° ëª©ë¡ -->
            <div class="col-lg-6 col-md-12 mb-4">
                <div class="card h-100 shadow-sm">
                    <div class="card-header bg-light">
                        <h4 class="mb-0"><i class="bi bi-stopwatch me-2"></i>ì˜ˆì •ëœ ê²½ê¸° (Waiting List)</h4>
                    </div>
                    <div class="card-body" id="scheduledMatchesContainer">
                        <div th:each="match : ${scheduledMatches}"
                             class="match-card"
                             th:data-match-id="${match.id}">
                            <div class="match-card-header">
                                <span th:text="${match.roundName + ' ' + match.matchNumber + 'ê²½ê¸°'}" class="text-secondary"></span>
                                <span th:classappend="|status-${match.status.name().toLowerCase()}|" class="status-badge" th:text="${match.status.description}"></span>
                            </div>
                            <div class="match-card-body">
                                <div class="player-info d-flex justify-content-between align-items-center mb-2">
                                    <span class="player-name text-start" th:text="${match.player1 != null ? match.player1.name : 'BYE'}">ê°•í•œì†”</span>
                                    <span class="fw-bold mx-2">VS</span>
                                    <span class="player-name text-end" th:text="${match.player2 != null ? match.player2.name : 'BYE'}">ê¹€ìš°ì§„</span>
                                </div>
                                <small class="text-muted text-center d-block" th:text="${#temporals.format(match.matchTime, 'MM-dd HH:mm')}"></small>
                                <div class="text-center mt-3" sec:authorize="hasAnyRole('ADMIN', 'MANAGER')">
                                    <button class="btn btn-success btn-sm fw-bold"
                                            th:data-match-id="${match.id}"
                                            th:data-round-name="${match.roundName}"
                                            th:data-player1-name="${match.player1 != null ? match.player1.name : 'BYE'}"
                                            th:data-player2-name="${match.player2 != null ? match.player2.name : 'BYE'}"
                                            onclick="openStartMatchModal(this)">
                                        <i class="bi bi-play-fill me-1"></i>ê²½ê¸° ì‹œì‘
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div th:if="${scheduledMatches.empty}" class="alert alert-info text-center mt-3">
                            <i class="bi bi-info-circle-fill me-2"></i> ì˜ˆì •ëœ ê²½ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤.
                        </div>
                    </div>
                </div>
            </div>

            <!-- ì§„í–‰ ì¤‘ì¸ ê²½ê¸° ëª©ë¡ -->
            <div class="col-lg-6 col-md-12 mb-4">
                <div class="card h-100 shadow-sm">
                    <div class="card-header bg-primary text-white">
                        <h4 class="mb-0"><i class="bi bi-controller me-2"></i>ì§„í–‰ ì¤‘ì¸ ê²½ê¸° (Live)</h4>
                    </div>
                    <div class="card-body" id="inProgressMatchesContainer">
                        <div th:each="match : ${inProgressMatches}"
                             class="match-card"
                             th:data-match-id="${match.id}">
                            <div class="match-card-header">
                                <span th:text="${match.roundName + ' ' + match.matchNumber + 'ê²½ê¸°'}" class="text-secondary"></span>
                                <span class="badge bg-danger ms-2" th:text="'íƒêµ¬ëŒ€ ' + ${match.tableNumber}">íƒêµ¬ëŒ€ 1</span>
                                <span th:classappend="|status-${match.status.name().toLowerCase()}|" class="status-badge" th:text="${match.status.description}"></span>
                            </div>
                            <div class="match-card-body">
                                <div class="player-info d-flex justify-content-between align-items-center mb-2">
                                    <span class="player-name text-start" th:text="${match.player1 != null ? match.player1.name : 'BYE'}">ê°•í•œì†”</span>
                                    <span class="fw-bold mx-2">VS</span>
                                    <span class="player-name text-end" th:text="${match.player2 != null ? match.player2.name : 'BYE'}">ê¹€ìš°ì§„</span>
                                </div>
                                <small class="text-muted text-center d-block" th:text="${#temporals.format(match.matchTime, 'MM-dd HH:mm')}"></small>
                                <div class="text-center mt-3" sec:authorize="hasAnyRole('ADMIN', 'MANAGER')">
                                    <button class="btn btn-primary btn-sm fw-bold"
                                            th:data-match-id="${match.id}"
                                            th:data-round-name="${match.roundName}"
                                            th:data-player1-name="${match.player1 != null ? match.player1.name : 'BYE'}"
                                            th:data-player2-name="${match.player2 != null ? match.player2.name : 'BYE'}"
                                            th:data-score1="${match.score1 ?: 0}"
                                            th:data-score2="${match.score2 ?: 0}"
                                            onclick="openCompleteMatchModal(this)">
                                        <i class="bi bi-trophy-fill me-1"></i>ì ìˆ˜ ì…ë ¥
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div th:if="${inProgressMatches.empty}" class="alert alert-info text-center mt-3">
                            <i class="bi bi-info-circle-fill me-2"></i> ì§„í–‰ ì¤‘ì¸ ê²½ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- â­â­â­ Toast ì•Œë¦¼ ì¶”ê°€ â­â­â­ -->
    <div id="toast"></div>

    <!-- ê²½ê¸° ì‹œì‘ ëª¨ë‹¬ -->
    <div class="modal fade" id="startMatchModal" tabindex="-1" aria-labelledby="startMatchModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title" id="startMatchModalLabel">ê²½ê¸° ì‹œì‘ ë° íƒêµ¬ëŒ€ ë°°ì •</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="lead text-center"><strong id="modalMatchInfo"></strong></p>
                    <hr>
                    <h6 class="mb-3">íƒêµ¬ëŒ€ ì„ íƒ (ìµœëŒ€ 24ëŒ€)</h6>
                    <div class="table-list d-flex flex-wrap gap-3 justify-content-center" id="tableList">
                        <!-- íƒêµ¬ëŒ€ ëª©ë¡ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ìƒì„± -->
                    </div>
                    <input type="hidden" id="modalMatchId">
                    <input type="hidden" id="modalMatchRoundName">
                    <input type="hidden" id="modalPlayer1Name">
                    <input type="hidden" id="modalPlayer2Name">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ì ìˆ˜ ì…ë ¥ ëª¨ë‹¬ -->
    <div class="modal fade" id="completeMatchModal" tabindex="-1" aria-labelledby="completeMatchModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="completeMatchModalLabel">ê²½ê¸° ê²°ê³¼ ì…ë ¥</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="lead text-center mb-4"><strong id="modalCompleteMatchInfo"></strong></p>
                    <input type="hidden" id="modalCompleteMatchId">
                    <div class="row g-3">
                        <div class="col-6">
                            <label for="score1" class="form-label d-block text-center"><strong id="player1NameScore"></strong></label>
                            <input type="number" id="score1" class="form-control form-control-lg text-center" value="0" min="0">
                        </div>
                        <div class="col-6">
                            <label for="score2" class="form-label d-block text-center"><strong id="player2NameScore"></strong></label>
                            <input type="number" id="score2" class="form-control form-control-lg text-center" value="0" min="0">
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                    <button type="button" class="btn btn-primary" id="confirmCompleteMatchBtn">ê²°ê³¼ ì…ë ¥</button>
                </div>
            </div>
        </div>
    </div>

</div>

<th:block layout:fragment="script">
    <!-- â­â­â­ SockJSì™€ STOMP ë¼ì´ë¸ŒëŸ¬ë¦¬ ì¶”ê°€ â­â­â­ -->
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.6.1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

    <script th:inline="javascript">
        /*<![CDATA[*/
        const TOURNAMENT_ID = /*[[${tournament.id}]]*/ 0; // â­ WebSocket ì—°ê²°ìš©
        console.log("Thymeleafì—ì„œ ì „ë‹¬ëœ TOURNAMENT_ID:", TOURNAMENT_ID);

        // â­â­â­ CSRF í† í°ì„ ì„œë²„ì—ì„œ ì§ì ‘ ì£¼ì… â­â­â­
        const CSRF_TOKEN = /*[[${_csrf.token}]]*/ '';
        const CSRF_HEADER = /*[[${_csrf.headerName}]]*/ '';

        console.log('âœ… CSRF Token injected by Thymeleaf');
        console.log('   Token:', CSRF_TOKEN ? 'Found (' + CSRF_TOKEN.substring(0, 10) + '...)' : 'MISSING!');
        console.log('   Header:', CSRF_HEADER);

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì¶”ê°€ í™•ì¸ (ë””ë²„ê¹…ìš©)
        $(document).ready(function() {
            if (!CSRF_TOKEN || !CSRF_HEADER) {
                console.error('âŒ CSRF token NOT injected properly!');
                console.error('   CSRF_TOKEN:', CSRF_TOKEN);
                console.error('   CSRF_HEADER:', CSRF_HEADER);

                // ë©”íƒ€ íƒœê·¸ì—ì„œ ë‹¤ì‹œ ì‹œë„
                const csrfTokenMeta = document.querySelector('meta[name="_csrf"]');
                const csrfHeaderMeta = document.querySelector('meta[name="_csrf_header"]');

                if (csrfTokenMeta && csrfHeaderMeta) {
                    window.CSRF_TOKEN = csrfTokenMeta.getAttribute('content');
                    window.CSRF_HEADER = csrfHeaderMeta.getAttribute('content');
                    console.log('âš ï¸ CSRF token loaded from meta tags (fallback)');
                } else {
                    alert('ì‹¬ê°í•œ ë³´ì•ˆ ì„¤ì • ì˜¤ë¥˜: ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.');
                }
            }
        });

        // â­â­â­ [WebSocket ì—°ê²° ë° ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸] â­â­â­
        let stompClient = null;

        function connectWebSocket() {
            console.log('ğŸ”Œ Connecting to WebSocket...');
            const socket = new SockJS('/ws');
            stompClient = Stomp.over(socket);

            stompClient.connect({}, function(frame) {
                console.log('âœ… WebSocket Connected!', frame);

                // ëŒ€íšŒë³„ í† í”½ êµ¬ë…
                stompClient.subscribe('/topic/tournament/' + TOURNAMENT_ID, function(message) {
                    console.log('ğŸ“© Received WebSocket message:', message.body);
                    handleWebSocketMessage(JSON.parse(message.body));
                });

                console.log('ğŸ“¢ Subscribed to tournament updates: /topic/tournament/' + TOURNAMENT_ID);
            }, function(error) {
                console.error('âŒ WebSocket connection failed:', error);
                // 5ì´ˆ í›„ ì¬ì—°ê²° ì‹œë„
                setTimeout(connectWebSocket, 5000);
            });
        }

        function handleWebSocketMessage(data) {
            const messageType = data.type;
            const payload = data.payload;

            console.log('ğŸ“¦ Message Type:', messageType);
            console.log('ğŸ“¦ Payload:', payload);

            switch(messageType) {
                case 'MATCH_STARTED':
                    console.log('ğŸ¾ Match #' + payload.matchId + ' started on table ' + payload.tableNumber);
                    showToast('ğŸ¾ ê²½ê¸° ì‹œì‘! ê²½ê¸° #' + payload.matchId + 'ì´ ' + payload.tableNumber + 'ë²ˆ íƒêµ¬ëŒ€ì—ì„œ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    setTimeout(() => location.reload(), 1500);
                    break;

                case 'MATCH_COMPLETED':
                    console.log('ğŸ† Match #' + payload.matchId + ' completed. Winner: ' + payload.winner + ' (' + payload.score1 + ':' + payload.score2 + ')');
                    showToast('ğŸ† ê²½ê¸° ì™„ë£Œ! ' + payload.winner + ' ì„ ìˆ˜ê°€ ìŠ¹ë¦¬í–ˆìŠµë‹ˆë‹¤! (' + payload.score1 + ':' + payload.score2 + ')');
                    setTimeout(() => location.reload(), 1500);
                    break;

                case 'ROUND_COMPLETED':
                    console.log('ğŸ‰ Round ' + payload.roundName + ' completed! Next round generated.');
                    showToast('ğŸ‰ ë¼ìš´ë“œ ì™„ë£Œ! ' + payload.roundName + 'ì´ ì™„ë£Œë˜ì–´ ë‹¤ìŒ ë¼ìš´ë“œê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!');
                    setTimeout(() => location.reload(), 2000);
                    break;

                default:
                    console.warn('âš ï¸ Unknown message type:', messageType);
            }
        }

        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ WebSocket ì—°ê²°
        $(document).ready(function() {
            connectWebSocket();
        });

        // â­â­â­ [ê²½ê¸° ì‹œì‘ ëª¨ë‹¬ ì—´ê¸°] â­â­â­
        function openStartMatchModal(buttonElement) {
            const matchId = buttonElement.dataset.matchId;
            const roundName = buttonElement.dataset.roundName;
            const player1Name = buttonElement.dataset.player1Name;
            const player2Name = buttonElement.dataset.player2Name;

            $('#modalMatchId').val(matchId);
            $('#modalMatchRoundName').val(roundName);
            $('#modalPlayer1Name').val(player1Name);
            $('#modalPlayer2Name').val(player2Name);
            $('#modalMatchInfo').text(`${roundName} ${player1Name} vs ${player2Name}`);

            loadTableList();

            $('#startMatchModal').modal('show');
        }

        // â­â­â­ [íƒêµ¬ëŒ€ ëª©ë¡ ë¡œë“œ ë° í´ë¦­ ì´ë²¤íŠ¸] â­â­â­
        function loadTableList() {
            console.log('Loading table list...');
            const tableListDiv = $('#tableList');
            tableListDiv.empty();
            const totalTables = 24;

            $.ajax({
                url: `/match/inProgress/${TOURNAMENT_ID}`,
                method: 'GET',
                success: function(inProgressMatches) {
                    console.log('In-progress matches:', inProgressMatches);
                    const occupiedTables = inProgressMatches.map(m => m.tableNumber);
                    console.log('Occupied tables:', occupiedTables);

                    for (let i = 1; i <= totalTables; i++) {
                        const tableItem = $(`<div class="table-item">${i}</div>`);
                        let isOccupied = occupiedTables.includes(i);

                        if (isOccupied) {
                            tableItem.addClass('occupied');
                            const match = inProgressMatches.find(m => m.tableNumber === i);
                            const p1Name = match.player1 != null ? match.player1.name : 'BYE';
                            const p2Name = match.player2 != null ? match.player2.name : 'BYE';
                            tableItem.append(`<span class="small-text">${p1Name} vs ${p2Name}</span>`);
                            tableItem.attr('title', `ì§„í–‰ì¤‘: ${p1Name} vs ${p2Name}`);
                        } else {
                            tableItem.addClass('available');
                            tableItem.attr('title', `íƒêµ¬ëŒ€ ${i}ë²ˆ - ì‚¬ìš© ê°€ëŠ¥`);
                            tableItem.on('click', function() {
                                const matchId = $('#modalMatchId').val();
                                const roundName = $('#modalMatchRoundName').val();
                                const player1Name = $('#modalPlayer1Name').val();
                                const player2Name = $('#modalPlayer2Name').val();

                                console.log('Table clicked:', {
                                    tableNumber: i,
                                    matchId: matchId,
                                    roundName: roundName,
                                    players: `${player1Name} vs ${player2Name}`
                                });

                                if (confirm(`${roundName}\n${player1Name} vs ${player2Name}\n\níƒêµ¬ëŒ€ ${i}ë²ˆì—ì„œ ê²½ê¸°ë¥¼ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                                    startMatch(matchId, i);
                                }
                            });
                        }
                        tableListDiv.append(tableItem);
                    }

                    console.log('Table list loaded successfully');
                },
                error: function(xhr, status, error) {
                    console.error("Failed to load in-progress matches:", {
                        status: xhr.status,
                        statusText: xhr.statusText,
                        error: error
                    });
                    alert("ì§„í–‰ ì¤‘ì¸ ê²½ê¸° ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                }
            });
        }

        // â­â­â­ [ê²½ê¸° ì‹œì‘ API í˜¸ì¶œ] â­â­â­
        function startMatch(matchId, tableNumber) {
            console.log('=== startMatch called ===');
            console.log('Match ID:', matchId);
            console.log('Table Number:', tableNumber);
            console.log('CSRF_TOKEN:', CSRF_TOKEN ? 'Available' : 'NULL');
            console.log('CSRF_HEADER:', CSRF_HEADER);

            // â­ ì „ì—­ ë³€ìˆ˜ ì‚¬ìš©
            if (!CSRF_TOKEN || !CSRF_HEADER) {
                console.error('âŒ CSRF token not available');
                alert('ë³´ì•ˆ í† í°ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');
                return;
            }

            $.ajax({
                url: `/match/start/${matchId}`,
                method: 'POST',
                data: { tableNumber: tableNumber },
                beforeSend: function(xhr) {
                    xhr.setRequestHeader(CSRF_HEADER, CSRF_TOKEN);
                    console.log('ğŸ“¤ Sending request with CSRF header:', CSRF_HEADER);
                },
                success: function(response) {
                    console.log('âœ… Match started successfully:', response);
                    alert(response.message || 'ê²½ê¸°ê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    $('#startMatchModal').modal('hide');
                    setTimeout(() => location.reload(), 500);
                },
                error: function(xhr, status, error) {
                    console.error('âŒ Error starting match:', {
                        status: xhr.status,
                        statusText: xhr.statusText,
                        response: xhr.responseJSON,
                        error: error
                    });
                    let errorMessage = xhr.responseJSON?.error || xhr.responseJSON?.message || "ê²½ê¸° ì‹œì‘ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.";
                    alert(errorMessage);
                }
            });
        }

        // â­â­â­ [ì ìˆ˜ ì…ë ¥ ëª¨ë‹¬ ì—´ê¸°] â­â­â­
        function openCompleteMatchModal(buttonElement) {
            const matchId = buttonElement.dataset.matchId;
            const roundName = buttonElement.dataset.roundName;
            const player1Name = buttonElement.dataset.player1Name;
            const player2Name = buttonElement.dataset.player2Name;
            const score1 = buttonElement.dataset.score1;
            const score2 = buttonElement.dataset.score2;

            $('#modalCompleteMatchId').val(matchId);
            $('#modalCompleteMatchInfo').text(`${roundName} ${player1Name} vs ${player2Name}`);
            $('#player1NameScore').text(player1Name);
            $('#player2NameScore').text(player2Name);
            $('#score1').val(score1);
            $('#score2').val(score2);
            $('#completeMatchModal').modal('show');
        }

        // â­â­â­ [ì ìˆ˜ ì…ë ¥ ë° ì™„ë£Œ API í˜¸ì¶œ] â­â­â­
        $('#confirmCompleteMatchBtn').on('click', function() {
            const matchId = $('#modalCompleteMatchId').val();
            const score1 = $('#score1').val();
            const score2 = $('#score2').val();

            if (score1 === '' || score2 === '') {
                alert('ì ìˆ˜ë¥¼ ëª¨ë‘ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
                return;
            }
            if (parseInt(score1) === parseInt(score2)) {
                alert('ë¬´ìŠ¹ë¶€ëŠ” í—ˆìš©ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ìŠ¹íŒ¨ë¥¼ ëª…í™•íˆ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
                return;
            }

            // â­ CSRF í† í° ê°€ì ¸ì˜¤ê¸°
            const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
            const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

            $.ajax({
                url: `/match/complete/${matchId}`,
                method: 'POST',
                data: { score1: score1, score2: score2 },
                beforeSend: function(xhr) {
                    // â­ CSRF í† í° í—¤ë”ì— ì¶”ê°€
                    xhr.setRequestHeader(csrfHeader, csrfToken);
                },
                success: function(response) {
                    alert(response.message);
                    $('#completeMatchModal').modal('hide');
                    // WebSocketì´ ìë™ ì—…ë°ì´íŠ¸í•˜ì§€ë§Œ, ì¦‰ì‹œ ë°˜ì˜ì„ ìœ„í•´ ë¦¬ë¡œë“œ
                    setTimeout(() => location.reload(), 500);
                },
                error: function(xhr, status, error) {
                    let errorMessage = xhr.responseJSON && xhr.responseJSON.error ? xhr.responseJSON.error : "ê²½ê¸° ì™„ë£Œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.";
                    alert(errorMessage);
                    console.error("Error completing match:", status, error, xhr);
                }
            });
        });

        // â­â­â­ [ì˜ˆì„  ëŒ€ì§„í‘œ ìƒì„± API í˜¸ì¶œ] â­â­â­
        function createPreliminary(tournamentId) {
            if (confirm("ì˜ˆì„  ëŒ€ì§„í‘œë¥¼ ìƒì„±í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì¡°ë³„ ë¦¬ê·¸ì „ ê²½ê¸°ê°€ ìë™ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤.")) {
                console.log('=== createPreliminary called ===');
                console.log('Tournament ID:', tournamentId);

                if (!CSRF_TOKEN || !CSRF_HEADER) {
                    console.error('âŒ CSRF token not available');
                    alert('ë³´ì•ˆ í† í°ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');
                    return;
                }

                $.ajax({
                    url: `/tournament/createPreliminary/${tournamentId}`,
                    method: 'POST',
                    beforeSend: function(xhr) {
                        xhr.setRequestHeader(CSRF_HEADER, CSRF_TOKEN);
                        console.log('ğŸ“¤ Sending createPreliminary request with CSRF');
                    },
                    success: function(response) {
                        console.log('âœ… Preliminary bracket created successfully:', response);
                        alert(response.message + '\nìƒì„±ëœ ê²½ê¸° ìˆ˜: ' + response.matchCount + 'ê°œ');
                        location.reload();
                    },
                    error: function(xhr, status, error) {
                        console.error('âŒ Error creating preliminary bracket:', {
                            status: xhr.status,
                            statusText: xhr.statusText,
                            response: xhr.responseJSON,
                            responseText: xhr.responseText,
                            error: error
                        });
                        let errorMessage = xhr.responseJSON?.error || xhr.responseJSON?.message || "ì˜ˆì„  ëŒ€ì§„í‘œ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.";
                        alert(errorMessage);
                    }
                });
            }
        }

        // â­â­â­ [ë³¸ì„  ëŒ€ì§„í‘œ ìƒì„± API í˜¸ì¶œ] â­â­â­
        function createMainBracket(tournamentId) {
            if (confirm("ë³¸ì„  ëŒ€ì§„í‘œë¥¼ ìƒì„±í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ì˜ˆì„  ëª¨ë“  ê²½ê¸°ê°€ ì™„ë£Œë˜ì–´ì•¼ í•©ë‹ˆë‹¤.)")) {
                console.log('=== createMainBracket called ===');
                console.log('Tournament ID:', tournamentId);
                console.log('CSRF_TOKEN:', CSRF_TOKEN ? 'Available' : 'NULL');
                console.log('CSRF_HEADER:', CSRF_HEADER);

                if (!CSRF_TOKEN || !CSRF_HEADER) {
                    console.error('âŒ CSRF token not available');
                    alert('ë³´ì•ˆ í† í°ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');
                    return;
                }

                $.ajax({
                    url: `/tournament/createMainBracket/${tournamentId}`,
                    method: 'POST',
                    beforeSend: function(xhr) {
                        xhr.setRequestHeader(CSRF_HEADER, CSRF_TOKEN);
                        console.log('ğŸ“¤ Sending createMainBracket request with CSRF');
                    },
                    success: function(response) {
                        console.log('âœ… Main bracket created successfully:', response);
                        alert(response.message || 'ë³¸ì„  ëŒ€ì§„í‘œê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.');
                        // ê°•ì œ ìƒˆë¡œê³ ì¹¨ (ìºì‹œ ë¬´ì‹œ)
                        window.location.href = window.location.href + '?refresh=' + new Date().getTime();
                    },
                    error: function(xhr, status, error) {
                        console.error('âŒ Error creating main bracket:', {
                            status: xhr.status,
                            statusText: xhr.statusText,
                            response: xhr.responseJSON,
                            responseText: xhr.responseText,
                            error: error
                        });
                        let errorMessage = xhr.responseJSON?.error || xhr.responseJSON?.message || "ë³¸ì„  ëŒ€ì§„í‘œ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.";
                        alert(errorMessage);
                    }
                });
            }
        }
        /*]]>*/
    </script>
</th:block>
</body>
</html>