<!DOCTYPE html>
<html layout:decorate="~{layout}" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security" xmlns:th="http://www.thymeleaf.org">
<head>
    <title>내 프로필</title>
    <th:block layout:fragment="css">
        <style>
            .profile-hero {
                background: linear-gradient(135deg, #0a2540 0%, #1a3a6b 100%);
                color: white; padding: 2.5rem 0 4.5rem;
                position: relative; overflow: hidden;
            }
            .profile-hero::after {
                content: ''; position: absolute;
                bottom: -2px; left: 0; right: 0; height: 50px;
                background: var(--bg-light);
                clip-path: ellipse(55% 100% at 50% 100%);
            }
            .profile-avatar {
                width: 80px; height: 80px; border-radius: 50%;
                background: linear-gradient(135deg, #7c3aed, #5b21b6);
                display: flex; align-items: center; justify-content: center;
                font-size: 2rem; font-weight: 900; color: white;
                border: 3px solid rgba(255,255,255,0.3);
                box-shadow: 0 8px 24px rgba(0,0,0,0.3);
            }
            .profile-card {
                background: var(--bg-white);
                border-radius: 20px;
                border: 1px solid var(--border-color);
                box-shadow: var(--shadow-lg);
                overflow: hidden;
                margin-top: -2.5rem; position: relative; z-index: 2;
            }
            .info-section {
                padding: 1.5rem;
                border-bottom: 1px solid var(--border-color);
            }
            .info-field {
                display: flex; align-items: center;
                padding: 0.75rem 0;
                border-bottom: 1px solid var(--border-color);
                gap: 1rem;
            }
            .info-field:last-child { border-bottom: none; }
            .info-label {
                width: 90px; font-size: 0.75rem;
                font-weight: 700; color: var(--text-secondary);
                text-transform: uppercase; letter-spacing: 0.04em; flex-shrink: 0;
            }
            .info-value { font-weight: 600; color: var(--text-primary); font-size: 0.93rem; }
            .role-chip {
                display: inline-flex; align-items: center; gap: 0.3rem;
                padding: 0.2rem 0.65rem; border-radius: 20px;
                font-size: 0.75rem; font-weight: 700;
            }
            .role-admin   { background: #fee2e2; color: #dc2626; }
            .role-manager { background: #fef3c7; color: #d97706; }
            .role-user    { background: #dbeafe; color: #2563eb; }

            /* 참가 내역 테이블 */
            .participation-table { width: 100%; border-collapse: collapse; }
            .participation-table th {
                padding: 0.7rem 1rem;
                font-size: 0.72rem; font-weight: 700;
                text-transform: uppercase; letter-spacing: 0.04em;
                color: var(--text-secondary);
                background: var(--bg-light);
                border-bottom: 2px solid var(--border-color);
            }
            .participation-table td {
                padding: 0.85rem 1rem; font-size: 0.88rem;
                border-bottom: 1px solid var(--border-color);
                color: var(--text-primary);
            }
            .participation-table tr:last-child td { border-bottom: none; }
            .participation-table tr:hover td { background: var(--bg-light); }
            .p-status {
                display: inline-flex; align-items: center;
                padding: 0.2rem 0.6rem; border-radius: 20px;
                font-size: 0.72rem; font-weight: 700;
            }
            .p-applied  { background: #dbeafe; color: #2563eb; }
            .p-approved { background: #d1fae5; color: #059669; }
            .p-paid     { background: #e0e7ff; color: #7c3aed; }
            .p-canceled { background: #f3f4f6; color: #6b7280; }
        </style>
    </th:block>
</head>
<body>
<div layout:fragment="content">

    <!-- 히어로 -->
    <div class="profile-hero">
        <div class="container position-relative" style="z-index:1;">
            <div class="d-flex align-items-center gap-3">
                <div class="profile-avatar">
                    <span sec:authentication="name" th:with="name=${#authentication.name}">
                        <span th:if="${#strings.length(name) > 0}" th:text="${#strings.substring(name, 0, 1)}">U</span>
                    </span>
                </div>
                <div>
                    <h2 class="fw-black mb-0" style="font-size:1.7rem; letter-spacing:-0.02em;">
                        <span th:text="${user.name}">사용자명</span>
                    </h2>
                    <p class="mb-0 opacity-70" style="font-size:0.85rem;" th:text="${user.email}">email@example.com</p>
                </div>
            </div>
        </div>
    </div>

    <div class="container pb-5">
        <div class="row g-4">

            <!-- 프로필 카드 -->
            <div class="col-lg-4">
                <div class="profile-card">
                    <div class="info-section">
                        <h6 class="fw-bold mb-3" style="font-size:0.8rem; text-transform:uppercase; letter-spacing:0.06em; color:var(--text-secondary);">
                            <i class="bi bi-person me-1"></i>기본 정보
                        </h6>
                        <div class="info-field">
                            <span class="info-label">아이디</span>
                            <span class="info-value" sec:authentication="name">아이디</span>
                        </div>
                        <div class="info-field">
                            <span class="info-label">이름</span>
                            <span class="info-value fw-bold" th:text="${user.name}">이름</span>
                        </div>
                        <div class="info-field">
                            <span class="info-label">이메일</span>
                            <span class="info-value" th:text="${user.email}">email</span>
                        </div>
                        <div class="info-field">
                            <span class="info-label">권한</span>
                            <span class="role-chip role-admin" sec:authorize="hasRole('ADMIN')">
                                <i class="bi bi-shield-fill"></i>관리자
                            </span>
                            <span class="role-chip role-manager" sec:authorize="hasRole('MANAGER')">
                                <i class="bi bi-person-gear"></i>매니저
                            </span>
                            <span class="role-chip role-user" sec:authorize="hasRole('USER')">
                                <i class="bi bi-person"></i>일반 사용자
                            </span>
                        </div>
                    </div>
                    <div class="p-3">
                        <a th:href="@{/user/changePassword}" class="btn btn-outline-primary w-100 fw-bold" style="border-radius:10px;">
                            <i class="bi bi-key me-2"></i>비밀번호 변경
                        </a>
                    </div>
                </div>
            </div>

            <!-- 참가 신청 내역 -->
            <div class="col-lg-8">
                <div class="profile-card" style="margin-top:0;">
                    <div class="info-section d-flex align-items-center justify-content-between" style="padding:1rem 1.5rem;">
                        <h5 class="fw-bold mb-0" style="color:var(--text-primary);">
                            <i class="bi bi-clipboard-check me-2" style="color:var(--primary-color);"></i>참가 신청 내역
                        </h5>
                        <span class="badge bg-primary" style="font-size:0.75rem;"
                              th:if="${participations != null}"
                              th:text="${participations.size() + '건'}">0건</span>
                    </div>

                    <div th:if="${participations != null && !participations.empty}" class="table-responsive">
                        <table class="participation-table">
                            <thead>
                            <tr>
                                <th>대회명</th>
                                <th>신청일</th>
                                <th>상태</th>
                                <th>관리</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr th:each="p : ${participations}">
                                <td>
                                    <a th:href="@{/tournament/detail/{id}(id=${p.tournament.id})}"
                                       class="fw-bold text-decoration-none"
                                       style="color:var(--text-primary);"
                                       th:text="${p.tournament.title}">대회명</a>
                                </td>
                                <td style="color:var(--text-secondary);"
                                    th:text="${#temporals.format(p.registeredAt, 'MM/dd HH:mm')}">날짜</td>
                                <td>
                                    <span class="p-status"
                                          th:classappend="${p.status == '신청완료' ? ' p-applied' :
                                                           (p.status == '승인완료' ? ' p-approved' :
                                                           (p.status == '입금완료' ? ' p-paid' : ' p-canceled'))}"
                                          th:text="${p.status}">상태</span>
                                </td>
                                <td>
                                    <form th:if="${p.status == '신청완료'}"
                                          th:action="@{/participation/cancel/{id}(id=${p.id})}"
                                          method="post" style="display:inline;">
                                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                                        <button type="submit" class="btn btn-outline-danger btn-sm fw-bold"
                                                style="font-size:0.75rem; padding:0.2rem 0.6rem;"
                                                onclick="return confirm('참가 신청을 취소하시겠습니까?');">
                                            <i class="bi bi-x me-1"></i>취소
                                        </button>
                                    </form>
                                    <span th:if="${p.status != '신청완료'}" class="text-muted" style="font-size:0.78rem;">-</span>
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>

                    <div th:if="${participations == null || participations.empty}"
                         class="text-center py-5" style="color:var(--text-secondary);">
                        <i class="bi bi-clipboard-x" style="font-size:3rem; opacity:0.25; display:block; margin-bottom:1rem;"></i>
                        <p class="mb-2">참가 신청 내역이 없습니다.</p>
                        <a th:href="@{/tournament/list(status=RECRUITING)}" class="btn btn-primary btn-sm fw-bold" style="border-radius:8px;">
                            <i class="bi bi-search me-1"></i>접수중인 대회 보기
                        </a>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>
</body>
</html>
