<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      layout:decorate="~{layout}">
<head>
    <title th:text="${player.name} + ' - ÏÑ†Ïàò ÌîÑÎ°úÌïÑ'">ÏÑ†Ïàò ÌîÑÎ°úÌïÑ</title>
    <th:block layout:fragment="css">
        <style>
            .player-hero {
                background: linear-gradient(135deg, #0a2540 0%, #1a3a6b 100%);
                color: white; padding: 3rem 0 5rem;
                position: relative; overflow: hidden;
            }
            .player-hero::after {
                content: ''; position: absolute;
                bottom: -2px; left: 0; right: 0; height: 60px;
                background: var(--bg-light);
                clip-path: ellipse(55% 100% at 50% 100%);
            }
            .player-avatar-lg {
                width: 96px; height: 96px; border-radius: 50%;
                display: flex; align-items: center; justify-content: center;
                font-size: 2.5rem; font-weight: 900; color: white;
                flex-shrink: 0;
                border: 3px solid rgba(255,255,255,0.3);
                box-shadow: 0 8px 24px rgba(0,0,0,0.3);
            }
            .profile-card {
                background: var(--bg-white);
                border-radius: 20px;
                border: 1px solid var(--border-color);
                box-shadow: var(--shadow-lg);
                overflow: hidden;
                margin-top: -3rem;
                position: relative; z-index: 2;
            }
            .info-row {
                display: flex; align-items: center;
                padding: 0.9rem 1.5rem;
                border-bottom: 1px solid var(--border-color);
                gap: 1rem;
            }
            .info-row:last-child { border-bottom: none; }
            .info-row-label {
                width: 100px; font-size: 0.78rem;
                font-weight: 700; color: var(--text-secondary);
                text-transform: uppercase; letter-spacing: 0.04em;
                flex-shrink: 0;
            }
            .info-row-value { font-size: 0.95rem; font-weight: 600; color: var(--text-primary); }

            .stat-grid {
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                gap: 1px;
                background: var(--border-color);
            }
            .stat-cell {
                background: var(--bg-white);
                padding: 1.2rem 1rem; text-align: center;
            }
            .stat-cell .num {
                font-size: 1.6rem; font-weight: 900;
                color: var(--primary-color); line-height: 1;
            }
            .stat-cell .lbl {
                font-size: 0.72rem; color: var(--text-secondary);
                font-weight: 600; margin-top: 0.3rem;
            }

            .ranking-badge {
                display: inline-flex; align-items: center; gap: 0.4rem;
                padding: 0.35rem 0.9rem; border-radius: 20px;
                font-weight: 800; font-size: 0.85rem;
            }
            .ranking-top3  { background: var(--gradient-gold); color: #5d3800; }
            .ranking-top10 { background: linear-gradient(135deg, #c0c0c0, #9e9e9e); color: white; }
            .ranking-other { background: linear-gradient(135deg, #cd7f32, #a0522d); color: white; }

            .gender-badge-m { background: #dbeafe; color: #1d4ed8; }
            .gender-badge-f { background: #fce7f3; color: #be185d; }

            .action-bar {
                display: flex; gap: 0.7rem; flex-wrap: wrap;
                padding: 1.2rem 1.5rem;
                border-top: 1px solid var(--border-color);
                background: var(--bg-light);
            }
        </style>
    </th:block>
</head>
<body>
<div layout:fragment="content">

    <!-- ÌûàÏñ¥Î°ú -->
    <div class="player-hero">
        <div class="container position-relative" style="z-index:1;">
            <!-- Î∏åÎ†àÎìúÌÅ¨Îüº -->
            <div class="d-flex align-items-center gap-2 mb-4" style="font-size:0.82rem; opacity:0.6;">
                <a th:href="@{/player/list}" style="color:inherit; text-decoration:none;">
                    <i class="bi bi-people me-1"></i>ÏÑ†Ïàò Î™©Î°ù
                </a>
                <i class="bi bi-chevron-right"></i>
                <span th:text="${player.name}">ÏÑ†ÏàòÎ™Ö</span>
            </div>

            <div class="d-flex align-items-center gap-4 flex-wrap">
                <!-- ÏïÑÎ∞îÌÉÄ -->
                <div class="player-avatar-lg"
                     th:style="${player.gender == 'ÎÇ®' ? 'background: linear-gradient(135deg, #2563eb, #1d4ed8);' : 'background: linear-gradient(135deg, #db2777, #be185d);'}">
                    <span th:text="${#strings.substring(player.name, 0, 1)}">ÏÑ†</span>
                </div>

                <!-- Í∏∞Î≥∏ Ï†ïÎ≥¥ -->
                <div>
                    <div class="d-flex align-items-center gap-2 mb-1 flex-wrap">
                        <h1 class="fw-black mb-0" style="font-size: clamp(1.6rem, 4vw, 2.4rem); letter-spacing:-0.02em;"
                            th:text="${player.name}">ÏÑ†ÏàòÎ™Ö</h1>
                        <span class="ranking-badge"
                              th:if="${player.ranking != null}"
                              th:classappend="${player.ranking <= 3 ? ' ranking-top3' : (player.ranking <= 10 ? ' ranking-top10' : ' ranking-other')}">
                            <i class="bi bi-trophy-fill"></i>
                            <span th:text="${player.ranking + 'ÏúÑ'}">1ÏúÑ</span>
                        </span>
                    </div>
                    <div class="d-flex align-items-center gap-2 flex-wrap mt-1" style="opacity:0.8;">
                        <span th:if="${player.club != null}" style="font-size:0.9rem;">
                            <i class="bi bi-building me-1"></i>
                            <span th:text="${player.club.name}">ÌÅ¥ÎüΩÎ™Ö</span>
                        </span>
                        <span th:if="${player.age != null}" style="font-size:0.9rem;">
                            <i class="bi bi-calendar me-1"></i>
                            <span th:text="${player.age + 'ÏÑ∏'}">25ÏÑ∏</span>
                        </span>
                        <span th:if="${player.position != null}" style="font-size:0.9rem;">
                            <i class="bi bi-bullseye me-1"></i>
                            <span th:text="${player.position}">Í≥µÍ≤©Ìòï</span>
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Î©îÏù∏ Ïª®ÌÖêÏ∏† -->
    <div class="container pb-5" style="position:relative; z-index:2;">

        <!-- ÏïåÎ¶º -->
        <div th:if="${message}" class="alert alert-success alert-dismissible fade show mb-4" role="alert">
            <i class="bi bi-check-circle-fill me-2"></i><span th:text="${message}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        <div th:if="${error}" class="alert alert-danger alert-dismissible fade show mb-4" role="alert">
            <i class="bi bi-exclamation-triangle-fill me-2"></i><span th:text="${error}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>

        <div class="row g-4">

            <!-- ÌîÑÎ°úÌïÑ Ïπ¥Îìú -->
            <div class="col-lg-5">
                <div class="profile-card">
                    <!-- ÌÜµÍ≥Ñ Í∑∏Î¶¨Îìú -->
                    <div class="stat-grid">
                        <div class="stat-cell">
                            <div class="num" th:text="${player.ranking != null ? player.ranking : '-'}">-</div>
                            <div class="lbl">Îû≠ÌÇπ</div>
                        </div>
                        <div class="stat-cell">
                            <div class="num" th:text="${player.age != null ? player.age : '-'}">-</div>
                            <div class="lbl">ÎÇòÏù¥</div>
                        </div>
                        <div class="stat-cell">
                            <div class="num" style="font-size:1rem;"
                                 th:text="${player.club != null ? player.club.name : '-'}">-</div>
                            <div class="lbl">ÏÜåÏÜç ÌÅ¥ÎüΩ</div>
                        </div>
                    </div>

                    <!-- ÏÉÅÏÑ∏ Ï†ïÎ≥¥ -->
                    <div class="info-row">
                        <span class="info-row-label">Ïù¥Î¶Ñ</span>
                        <span class="info-row-value fw-bold" th:text="${player.name}">Ïù¥Î¶Ñ</span>
                    </div>
                    <div class="info-row">
                        <span class="info-row-label">ÏÑ±Î≥Ñ</span>
                        <span class="info-row-value">
                            <span class="ranking-badge"
                                  th:classappend="${player.gender == 'ÎÇ®' ? ' gender-badge-m' : ' gender-badge-f'}"
                                  style="font-size:0.78rem; padding:0.2rem 0.7rem;"
                                  th:text="${player.gender == 'ÎÇ®' ? 'ÎÇ®ÏÑ±' : (player.gender == 'Ïó¨' ? 'Ïó¨ÏÑ±' : (player.gender != null ? player.gender : '-'))}">-</span>
                        </span>
                    </div>
                    <div class="info-row" th:if="${player.age != null}">
                        <span class="info-row-label">ÎÇòÏù¥</span>
                        <span class="info-row-value" th:text="${player.age + 'ÏÑ∏'}">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-row-label">Îû≠ÌÇπ</span>
                        <span class="info-row-value">
                            <span th:if="${player.ranking != null}"
                                  class="ranking-badge"
                                  th:classappend="${player.ranking <= 3 ? ' ranking-top3' : (player.ranking <= 10 ? ' ranking-top10' : ' ranking-other')}"
                                  style="font-size:0.78rem; padding:0.2rem 0.7rem;"
                                  th:text="${player.ranking + 'ÏúÑ'}">-</span>
                            <span th:unless="${player.ranking != null}" class="text-muted">ÎØ∏Ï†ï</span>
                        </span>
                    </div>
                    <div class="info-row" th:if="${player.position != null}">
                        <span class="info-row-label">ÌîåÎ†àÏù¥Ïä§ÌÉÄÏùº</span>
                        <span class="info-row-value" th:text="${player.position}">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-row-label">ÏÜåÏÜç ÌÅ¥ÎüΩ</span>
                        <span class="info-row-value">
                            <a th:if="${player.club != null}"
                               th:href="@{/club/detail/{id}(id=${player.club.id})}"
                               class="fw-bold text-decoration-none"
                               th:text="${player.club.name}">ÌÅ¥ÎüΩÎ™Ö</a>
                            <span th:unless="${player.club != null}" class="text-muted">ÏÜåÏÜç ÏóÜÏùå</span>
                        </span>
                    </div>
                    <div class="info-row" th:if="${player.contactInfo != null}">
                        <span class="info-row-label">Ïó∞ÎùΩÏ≤ò</span>
                        <span class="info-row-value" th:text="${player.contactInfo}">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-row-label">Îì±Î°ùÏùº</span>
                        <span class="info-row-value text-muted"
                              th:text="${#temporals.format(player.createdAt, 'yyyyÎÖÑ MMÏõî ddÏùº')}">-</span>
                    </div>

                    <!-- Ïï°ÏÖò -->
                    <div class="action-bar">
                        <a th:href="@{/player/list}" class="btn btn-outline-secondary btn-sm fw-bold">
                            <i class="bi bi-arrow-left me-1"></i>Î™©Î°ù
                        </a>
                        <a sec:authorize="hasRole('ADMIN')"
                           th:href="@{/player/edit/{id}(id=${player.id})}"
                           class="btn btn-warning btn-sm fw-bold">
                            <i class="bi bi-pencil me-1"></i>ÏàòÏ†ï
                        </a>
                        <button sec:authorize="hasRole('ADMIN')"
                                type="button" class="btn btn-danger btn-sm fw-bold ms-auto delete-btn"
                                th:data-player-id="${player.id}"
                                th:data-player-name="${player.name}">
                            <i class="bi bi-trash me-1"></i>ÏÇ≠Ï†ú
                        </button>
                    </div>
                </div>
            </div>

            <!-- Ïö∞Ï∏° Ï†ïÎ≥¥ -->
            <div class="col-lg-7">
                <!-- ÏÑ†Ïàò Ï†ïÎ≥¥ ÏöîÏïΩ Ïπ¥Îìú -->
                <div class="card border-0 shadow-sm mb-4" style="border-radius:16px; overflow:hidden;">
                    <div class="card-body p-4">
                        <h5 class="fw-bold mb-3" style="color:var(--text-primary);">
                            <i class="bi bi-person-badge me-2" style="color:var(--primary-color);"></i>ÏÑ†Ïàò ÏÜåÍ∞ú
                        </h5>
                        <div class="row g-3">
                            <div class="col-sm-6">
                                <div style="background:var(--bg-light); border-radius:12px; padding:1rem;">
                                    <div style="font-size:0.72rem; font-weight:700; color:var(--text-secondary); text-transform:uppercase; letter-spacing:0.04em; margin-bottom:0.4rem;">ÌîåÎ†àÏù¥Ïä§ÌÉÄÏùº</div>
                                    <div style="font-weight:700; color:var(--text-primary);"
                                         th:text="${player.position != null ? player.position : 'Ï†ïÎ≥¥ ÏóÜÏùå'}">Í≥µÍ≤©Ìòï</div>
                                </div>
                            </div>
                            <div class="col-sm-6">
                                <div style="background:var(--bg-light); border-radius:12px; padding:1rem;">
                                    <div style="font-size:0.72rem; font-weight:700; color:var(--text-secondary); text-transform:uppercase; letter-spacing:0.04em; margin-bottom:0.4rem;">ÌòÑÏû¨ Îû≠ÌÇπ</div>
                                    <div style="font-weight:900; font-size:1.3rem;"
                                         th:classappend="${player.ranking != null && player.ranking <= 3 ? ' text-warning' : ''}"
                                         th:text="${player.ranking != null ? player.ranking + 'ÏúÑ' : 'ÎØ∏Ï†ï'}">-</div>
                                </div>
                            </div>
                            <div class="col-sm-6" th:if="${player.club != null}">
                                <div style="background:linear-gradient(135deg, rgba(0,102,204,0.08), rgba(0,73,153,0.04)); border:1px solid rgba(0,102,204,0.2); border-radius:12px; padding:1rem;">
                                    <div style="font-size:0.72rem; font-weight:700; color:var(--primary-color); text-transform:uppercase; letter-spacing:0.04em; margin-bottom:0.4rem;">ÏÜåÏÜç ÌÅ¥ÎüΩ</div>
                                    <a th:href="@{/club/detail/{id}(id=${player.club.id})}"
                                       style="font-weight:700; text-decoration:none; color:var(--primary-color);"
                                       th:text="${player.club.name}">ÌÅ¥ÎüΩÎ™Ö</a>
                                </div>
                            </div>
                            <div class="col-sm-6">
                                <div style="background:var(--bg-light); border-radius:12px; padding:1rem;">
                                    <div style="font-size:0.72rem; font-weight:700; color:var(--text-secondary); text-transform:uppercase; letter-spacing:0.04em; margin-bottom:0.4rem;">Îì±Î°ùÏùº</div>
                                    <div style="font-weight:600; color:var(--text-primary);"
                                         th:text="${#temporals.format(player.createdAt, 'yyyy.MM.dd')}">-</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Îû≠ÌÇπ ÏãúÍ∞ÅÌôî -->
                <div class="card border-0 shadow-sm mb-4" style="border-radius:16px; overflow:hidden;" th:if="${player.ranking != null}">
                    <div class="card-body p-4">
                        <h5 class="fw-bold mb-3" style="color:var(--text-primary);">
                            <i class="bi bi-bar-chart me-2" style="color:#f97316;"></i>Îû≠ÌÇπ ÌòÑÌô©
                        </h5>
                        <div class="d-flex align-items-center gap-3 mb-2">
                            <div style="font-size:3rem; font-weight:900;"
                                 th:classappend="${player.ranking <= 3 ? ' text-warning' : ''}"
                                 th:text="${player.ranking}">1</div>
                            <div>
                                <div style="font-size:0.85rem; color:var(--text-secondary);">ÌòÑÏû¨ ÏàúÏúÑ</div>
                                <div style="font-size:0.78rem; font-weight:700;"
                                     th:text="${player.ranking <= 3 ? 'üèÜ TOP 3 ÏÑ†Ïàò' : (player.ranking <= 10 ? '‚≠ê TOP 10 ÏÑ†Ïàò' : 'ÏÑ†Ïàò')}">-</div>
                            </div>
                        </div>
                        <div style="height:10px; background:var(--bg-light); border-radius:5px; overflow:hidden;">
                            <div style="height:100%; border-radius:5px; background: var(--gradient-gold); transition: width 1.2s ease;"
                                 th:style="'width:' + (${player.ranking <= 100 ? Math.max(5, 100 - player.ranking) : 5}) + '%'"></div>
                        </div>
                        <div class="d-flex justify-content-between mt-1" style="font-size:0.72rem; color:var(--text-secondary);">
                            <span>1ÏúÑ</span>
                            <span>100ÏúÑ+</span>
                        </div>
                    </div>
                </div>

                <!-- ‚≠ê Ï†ÑÏ†Å ÌÜµÍ≥Ñ (ÎèôÏ†Å Î°úÎî©) -->
                <div class="card border-0 shadow-sm" style="border-radius:16px; overflow:hidden;" id="statsCard">
                    <div class="card-body p-4">
                        <h5 class="fw-bold mb-3" style="color:var(--text-primary);">
                            <i class="bi bi-graph-up me-2" style="color:#6366f1;"></i>Ï†ÑÏ†Å ÌÜµÍ≥Ñ
                        </h5>
                        <div id="statsLoading" class="text-center py-3" style="color:var(--text-secondary);">
                            <div class="spinner-border spinner-border-sm me-2"></div>ÌÜµÍ≥Ñ Î∂àÎü¨Ïò§Îäî Ï§ë...
                        </div>
                        <div id="statsContent" style="display:none;">
                            <!-- Ïäπ/Ìå® ÏöîÏïΩ -->
                            <div class="row g-2 mb-3" id="statsSummary"></div>
                            <!-- ÏµúÍ∑º Í≤ΩÍ∏∞ -->
                            <div id="recentMatchesSection" style="display:none;">
                                <h6 class="fw-bold mb-2" style="font-size:0.82rem; color:var(--text-secondary); text-transform:uppercase; letter-spacing:0.04em;">ÏµúÍ∑º Í≤ΩÍ∏∞</h6>
                                <div id="recentMatchesList"></div>
                            </div>
                        </div>
                        <div id="statsEmpty" style="display:none; color:var(--text-secondary);" class="text-center py-3">
                            <i class="bi bi-clipboard-x" style="font-size:2rem; opacity:0.4;"></i>
                            <p class="mt-2 mb-0" style="font-size:0.88rem;">ÏïÑÏßÅ Í≤ΩÍ∏∞ Í∏∞Î°ùÏù¥ ÏóÜÏäµÎãàÎã§.</p>
                        </div>
                    </div>
                </div>
            </div>

        </div><!-- /row -->
    </div>

    <!-- ÏÇ≠Ï†ú Ìèº -->
    <form id="deleteForm" method="post" style="display:none;">
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
    </form>
</div>

<th:block layout:fragment="script">
    <script th:inline="javascript">
        const PLAYER_ID = /*[[${player.id}]]*/ 0;

        /* ÏÇ≠Ï†ú Î≤ÑÌäº */
        const deleteBtn = document.querySelector('.delete-btn');
        if (deleteBtn) {
            deleteBtn.addEventListener('click', function() {
                const id   = this.dataset.playerId;
                const name = this.dataset.playerName;
                if (confirm('"' + name + '" ÏÑ†ÏàòÎ•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?\nÏù¥ ÏûëÏóÖÏùÄ ÎêòÎèåÎ¶¥ Ïàò ÏóÜÏäµÎãàÎã§.')) {
                    const form = document.getElementById('deleteForm');
                    form.action = '/player/delete/' + id;
                    form.submit();
                }
            });
        }

        /* Ï†ÑÏ†Å ÌÜµÍ≥Ñ */
        document.addEventListener('DOMContentLoaded', function() {
            fetch('/player/stats/' + PLAYER_ID)
                .then(r => r.ok ? r.json() : null)
                .then(s => {
                    document.getElementById('statsLoading').style.display = 'none';
                    if (!s || s.totalMatches === 0) {
                        document.getElementById('statsEmpty').style.display = 'block';
                        return;
                    }
                    document.getElementById('statsContent').style.display = 'block';

                    /* ÏöîÏïΩ Ïπ¥Îìú */
                    const wrap = document.getElementById('statsSummary');
                    const cards = [
                        { label:'Ï¥ù Í≤ΩÍ∏∞', value: s.totalMatches, color:'#6366f1', icon:'bi-controller' },
                        { label:'ÏäπÎ¶¨',    value: s.wins,         color:'#10b981', icon:'bi-trophy-fill' },
                        { label:'Ìå®Î∞∞',    value: s.losses,       color:'#ef4444', icon:'bi-x-circle-fill' },
                        { label:'ÏäπÎ•†',    value: s.winRate + '%', color:'#f97316', icon:'bi-percent' }
                    ];
                    wrap.innerHTML = cards.map(c => `
                        <div class="col-6 col-sm-3">
                            <div style="background:var(--bg-light);border-radius:12px;padding:0.8rem;text-align:center;">
                                <i class="bi ${c.icon}" style="color:${c.color};font-size:1.1rem;"></i>
                                <div style="font-size:1.4rem;font-weight:900;color:${c.color};line-height:1.2;">${c.value}</div>
                                <div style="font-size:0.7rem;color:var(--text-secondary);font-weight:600;">${c.label}</div>
                            </div>
                        </div>`).join('');

                    /* ÏµúÍ∑º Í≤ΩÍ∏∞ Î™©Î°ù */
                    if (s.recentMatches && s.recentMatches.length > 0) {
                        const section = document.getElementById('recentMatchesSection');
                        section.style.display = 'block';
                        const list = document.getElementById('recentMatchesList');
                        list.innerHTML = s.recentMatches.map(m => `
                            <div style="display:flex;align-items:center;gap:0.7rem;padding:0.6rem 0.8rem;border-radius:10px;background:var(--bg-light);margin-bottom:0.4rem;">
                                <span style="width:28px;height:28px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:0.75rem;font-weight:800;background:${m.win ? 'rgba(16,185,129,0.15)' : 'rgba(239,68,68,0.15)'};color:${m.win ? '#10b981' : '#ef4444'};">${m.resultLabel}</span>
                                <div style="flex:1;min-width:0;">
                                    <div style="font-size:0.82rem;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${m.tournamentTitle}</div>
                                    <div style="font-size:0.72rem;color:var(--text-secondary);">${m.roundName || ''} ¬∑ vs ${m.opponentName}</div>
                                </div>
                                <div style="text-align:right;flex-shrink:0;">
                                    <div style="font-size:0.9rem;font-weight:800;">${m.myScore ?? '-'} : ${m.opponentScore ?? '-'}</div>
                                </div>
                            </div>`).join('');
                    }
                })
                .catch(() => {
                    document.getElementById('statsLoading').style.display = 'none';
                    document.getElementById('statsEmpty').style.display = 'block';
                });
        });
    </script>
</th:block>
</body>
</html>
