<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" 
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      layout:decorate="~{layout}" 
      lang="ko">
<head>
    <title th:text="${post.title}">게시글 상세</title>
    <th:block layout:fragment="css">
        <style>
            .post-detail-container {
                max-width: 900px;
                margin: 0 auto;
            }
            .post-header {
                border-bottom: 2px solid #dee2e6;
                padding-bottom: 1rem;
                margin-bottom: 2rem;
            }
            .post-title {
                font-size: 1.75rem;
                font-weight: 700;
                margin-bottom: 1rem;
            }
            .post-meta {
                display: flex;
                gap: 1rem;
                color: #6c757d;
                font-size: 0.875rem;
            }
            .post-content {
                min-height: 300px;
                line-height: 1.8;
                margin-bottom: 2rem;
                padding: 2rem;
                background: #f8f9fa;
                border-radius: 8px;
                white-space: pre-wrap;
            }
            .post-actions {
                display: flex;
                gap: 0.5rem;
                justify-content: center;
                padding: 1.5rem 0;
                border-top: 1px solid #dee2e6;
                border-bottom: 1px solid #dee2e6;
            }
            .comment-section {
                margin-top: 3rem;
            }
            .comment-item {
                padding: 1rem;
                border-bottom: 1px solid #e9ecef;
            }
            .comment-author {
                font-weight: 600;
                color: #212529;
            }
            .comment-date {
                font-size: 0.875rem;
                color: #6c757d;
                margin-left: 0.5rem;
            }
            .comment-content {
                margin-top: 0.5rem;
                line-height: 1.6;
            }
        </style>
    </th:block>
</head>
<body>
<div layout:fragment="content">
    <div class="container my-5">
        <div class="post-detail-container">
            <!-- 게시글 헤더 -->
            <div class="post-header">
                <div class="post-title">
                    <span th:if="${post.category.name() == 'NOTICE'}" class="badge bg-warning text-dark me-2">공지</span>
                    <span th:text="${post.title}"></span>
                </div>
                <div class="post-meta">
                    <span><i class="bi bi-person me-1"></i><span th:text="${post.author.name}"></span></span>
                    <span><i class="bi bi-calendar me-1"></i><span th:text="${#temporals.format(post.createdAt, 'yyyy-MM-dd HH:mm')}"></span></span>
                    <span><i class="bi bi-eye me-1"></i><span th:text="${post.viewCount}"></span></span>
                    <span><i class="bi bi-heart me-1"></i><span th:text="${post.likeCount}"></span></span>
                </div>
            </div>

            <!-- 게시글 내용 -->
            <div class="post-content" th:text="${post.content}"></div>

            <!-- 게시글 액션 버튼 -->
            <div class="post-actions">
                <button type="button" class="btn btn-outline-danger" onclick="likePost()">
                    <i class="bi bi-heart me-1"></i>좋아요 <span th:text="${post.likeCount}"></span>
                </button>
                
                <!-- 작성자 또는 관리자만 수정/삭제 가능 -->
                <div sec:authorize="isAuthenticated()">
                    <a th:if="${#authentication.name == post.author.username or #authorization.expression('hasRole(''ADMIN'')')}"
                       th:href="@{/board/edit/{id}(id=${post.id})}" 
                       class="btn btn-outline-primary">
                        <i class="bi bi-pencil me-1"></i>수정
                    </a>
                    <form th:if="${#authentication.name == post.author.username or #authorization.expression('hasRole(''ADMIN'')')}"
                          th:action="@{/board/delete/{id}(id=${post.id})}" 
                          method="post" 
                          style="display: inline;"
                          onsubmit="return confirm('정말 삭제하시겠습니까?')">
                        <button type="submit" class="btn btn-outline-danger">
                            <i class="bi bi-trash me-1"></i>삭제
                        </button>
                    </form>
                </div>
                
                <!-- 관리자 전용: 상단 고정 -->
                <button type="button" 
                        class="btn btn-outline-warning" 
                        sec:authorize="hasRole('ADMIN')"
                        onclick="togglePin()">
                    <i class="bi bi-pin-angle me-1"></i>
                    <span th:text="${post.isPinned ? '고정 해제' : '상단 고정'}"></span>
                </button>
            </div>

            <!-- 목록으로 버튼 -->
            <div class="mt-3">
                <a th:href="@{/board/list(category=${post.category})}" class="btn btn-secondary">
                    <i class="bi bi-list me-2"></i>목록으로
                </a>
            </div>

            <!-- 댓글 섹션 -->
            <div class="comment-section">
                <h5 class="fw-bold mb-3">
                    <i class="bi bi-chat-dots me-2"></i>댓글 
                    <span class="text-muted" th:text="${comments.size()}"></span>
                </h5>

                <!-- 댓글 작성 폼 -->
                <div class="mb-4" sec:authorize="isAuthenticated()">
                    <form th:action="@{/board/comment/{postId}(postId=${post.id})}" method="post">
                        <div class="input-group">
                            <textarea name="content" 
                                     class="form-control" 
                                     rows="3" 
                                     placeholder="댓글을 입력하세요"
                                     required></textarea>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-send me-1"></i>등록
                            </button>
                        </div>
                    </form>
                </div>

                <!-- 댓글 목록 -->
                <div class="comment-list">
                    <div th:if="${comments.isEmpty()}" class="text-center text-muted py-4">
                        첫 댓글을 남겨보세요!
                    </div>
                    <div th:each="comment : ${comments}" class="comment-item">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <span class="comment-author" th:text="${comment.author.name}"></span>
                                <span class="comment-date" th:text="${#temporals.format(comment.createdAt, 'yyyy-MM-dd HH:mm')}"></span>
                                <div class="comment-content" th:text="${comment.content}"></div>
                            </div>
                            <!-- 댓글 작성자 또는 관리자만 삭제 가능 -->
                            <form th:if="${#authentication.name == comment.author.username or #authorization.expression('hasRole(''ADMIN'')')}"
                                  th:action="@{/board/comment/delete/{commentId}(commentId=${comment.id})}" 
                                  method="post"
                                  onsubmit="return confirm('댓글을 삭제하시겠습니까?')">
                                <input type="hidden" name="postId" th:value="${post.id}">
                                <button type="submit" class="btn btn-sm btn-outline-danger">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script th:inline="javascript">
        const postId = /*[[${post.id}]]*/ 0;
        
        function likePost() {
            fetch(`/board/like/${postId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    [[${_csrf.headerName}]]: [[${_csrf.token}]]
                }
            })
            .then(response => response.text())
            .then(data => {
                if (data === 'success') {
                    location.reload();
                }
            });
        }

        function togglePin() {
            if (confirm('상단 고정 상태를 변경하시겠습니까?')) {
                fetch(`/board/pin/${postId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        [[${_csrf.headerName}]]: [[${_csrf.token}]]
                    }
                })
                .then(response => response.text())
                .then(data => {
                    if (data === 'success') {
                        location.reload();
                    }
                });
            }
        }
    </script>
</div>
</body>
</html>
