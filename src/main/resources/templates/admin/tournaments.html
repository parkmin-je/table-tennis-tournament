<!DOCTYPE html>
<html layout:decorate="~{layout}" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:th="http://www.thymeleaf.org">
<head>
    <title>대회 목록 관리</title>
    <th:block layout:fragment="css">
    <style>
        .admin-hero {
            background: linear-gradient(135deg, #0d1b2a 0%, #1a2e44 100%);
            color: #fff; padding: 2.5rem 0 2rem;
            margin-bottom: 2rem; border-radius: 0 0 20px 20px;
        }
        .admin-hero h1 { font-size: 1.8rem; font-weight: 800; letter-spacing: -0.5px; }
        .admin-hero .breadcrumb { opacity: 0.6; font-size: 0.85rem; }
        .admin-hero .breadcrumb-item + .breadcrumb-item::before { color: rgba(255,255,255,0.4); }

        .stat-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 2rem; }
        .stat-box {
            border-radius: 14px; padding: 1.2rem 1rem; text-align: center; color: #fff;
        }
        .stat-box i { font-size: 1.6rem; display: block; margin-bottom: 6px; }
        .stat-box .num { font-size: 1.8rem; font-weight: 900; line-height: 1; }
        .stat-box .lbl { font-size: 0.8rem; opacity: 0.85; margin-top: 2px; }

        .admin-card { background: var(--bg-white); border-radius: 14px; box-shadow: var(--shadow-md); overflow: hidden; margin-bottom: 2rem; }
        .admin-card-header {
            background: linear-gradient(135deg, #1e3a5f 0%, #0d1b2a 100%);
            color: #fff; padding: 1rem 1.5rem;
            display: flex; align-items: center; justify-content: space-between;
        }
        .admin-card-header h5 { margin: 0; font-weight: 700; font-size: 1rem; }
        .btn-new-tournament {
            background: #10b981; color: #fff; border: none; border-radius: 8px;
            padding: 7px 14px; font-size: 0.85rem; font-weight: 600;
            text-decoration: none; display: inline-flex; align-items: center; gap: 5px; transition: all 0.2s;
        }
        .btn-new-tournament:hover { background: #059669; color: #fff; transform: translateY(-1px); }

        .admin-table { width: 100%; }
        .admin-table th {
            background: #f8f9fa; color: #6b7280; font-size: 0.75rem; font-weight: 700;
            text-transform: uppercase; letter-spacing: 0.5px; padding: 11px 14px;
            border-bottom: 2px solid #e5e7eb;
        }
        .admin-table td { padding: 12px 14px; font-size: 0.88rem; border-bottom: 1px solid #f3f4f6; vertical-align: middle; }
        .admin-table tr:hover td { background: #f8faff; }

        .type-badge { display: inline-block; padding: 3px 10px; border-radius: 50px; font-size: 0.75rem; font-weight: 600; background: #dbeafe; color: #1d4ed8; }
        .status-select {
            font-size: 0.8rem; padding: 4px 8px; border-radius: 8px;
            border: 1.5px solid #e5e7eb; min-width: 90px;
            background: #fff; cursor: pointer; transition: border-color 0.2s;
        }
        .status-select:hover { border-color: #3b82f6; }
        .status-select:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59,130,246,0.15); }

        .action-btns { display: flex; gap: 4px; justify-content: center; }
        .btn-act { width: 30px; height: 30px; border-radius: 7px; display: inline-flex; align-items: center; justify-content: center; font-size: 0.85rem; text-decoration: none; transition: all 0.2s; border: none; cursor: pointer; }
        .btn-act-view { background: #eff6ff; color: #3b82f6; }
        .btn-act-view:hover { background: #3b82f6; color: #fff; }
        .btn-act-edit { background: #fef3c7; color: #b45309; }
        .btn-act-edit:hover { background: #f59e0b; color: #fff; }
        .btn-act-del { background: #fef2f2; color: #ef4444; }
        .btn-act-del:hover { background: #ef4444; color: #fff; }

        .empty-state { text-align: center; padding: 60px 20px; color: #9ca3af; }
        .empty-state i { font-size: 3rem; display: block; margin-bottom: 12px; }

        [data-theme="dark"] .admin-table th { background: rgba(255,255,255,0.05); color: #9ca3af; border-color: rgba(255,255,255,0.08); }
        [data-theme="dark"] .admin-table td { border-color: rgba(255,255,255,0.06); }
        [data-theme="dark"] .admin-table tr:hover td { background: rgba(255,255,255,0.03); }
        [data-theme="dark"] .status-select { background: #1e1e30; border-color: #333344; color: #f0f0f0; }
        [data-theme="dark"] .btn-act-view { background: rgba(59,130,246,0.1); }
        [data-theme="dark"] .btn-act-edit { background: rgba(245,158,11,0.1); }
        [data-theme="dark"] .btn-act-del { background: rgba(239,68,68,0.1); }

        @media (max-width: 768px) {
            .stat-grid { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
    </th:block>
</head>
<body>
<div layout:fragment="content">

    <!-- Admin Hero -->
    <div class="admin-hero">
        <div class="container">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-2">
                    <li class="breadcrumb-item"><a href="/admin/dashboard" class="text-white-50">관리자</a></li>
                    <li class="breadcrumb-item active text-white">대회 관리</li>
                </ol>
            </nav>
            <div class="d-flex align-items-center justify-content-between flex-wrap gap-3">
                <div>
                    <h1><i class="bi bi-trophy-fill me-3"></i>대회 목록 관리</h1>
                    <p class="mb-0 opacity-75 small">전체 대회를 생성, 수정, 삭제할 수 있습니다</p>
                </div>
                <a href="/tournament/create" class="btn-new-tournament">
                    <i class="bi bi-plus-circle-fill"></i>새 대회 등록
                </a>
            </div>
        </div>
    </div>

    <div class="container pb-5">

        <!-- Alert -->
        <div th:if="${message}"
             th:classappend="${alertType != null ? 'alert-' + alertType : 'alert-info'}"
             class="alert alert-dismissible fade show rounded-3 mb-4" role="alert" id="flashAlert">
            <span th:text="${message}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>

        <!-- Stats Grid -->
        <div class="stat-grid">
            <div class="stat-box" style="background: linear-gradient(135deg,#6366f1,#4f46e5);">
                <i class="bi bi-trophy-fill"></i>
                <div class="num" th:text="${tournaments.size()}">0</div>
                <div class="lbl">전체 대회</div>
            </div>
            <div class="stat-box" style="background: linear-gradient(135deg,#10b981,#059669);">
                <i class="bi bi-person-plus-fill"></i>
                <div class="num" th:text="${#lists.size(tournaments.?[status.name() == 'RECRUITING'])}">0</div>
                <div class="lbl">접수 중</div>
            </div>
            <div class="stat-box" style="background: linear-gradient(135deg,#f97316,#ea580c);">
                <i class="bi bi-lightning-fill"></i>
                <div class="num" th:text="${#lists.size(tournaments.?[status.name() == 'IN_PROGRESS'])}">0</div>
                <div class="lbl">진행 중</div>
            </div>
            <div class="stat-box" style="background: linear-gradient(135deg,#6b7280,#4b5563);">
                <i class="bi bi-check-circle-fill"></i>
                <div class="num" th:text="${#lists.size(tournaments.?[status.name() == 'COMPLETED'])}">0</div>
                <div class="lbl">종료</div>
            </div>
        </div>

        <!-- Tournaments Table -->
        <div class="admin-card">
            <div class="admin-card-header">
                <h5><i class="bi bi-table me-2"></i>대회 목록</h5>
                <span class="badge bg-light text-dark" th:text="${tournaments.size()} + '개'">0개</span>
            </div>
            <div class="table-responsive">
                <table class="admin-table">
                    <thead>
                    <tr>
                        <th>ID</th>
                        <th>대회명</th>
                        <th>주최</th>
                        <th>유형</th>
                        <th>기간</th>
                        <th>상태</th>
                        <th>등록자</th>
                        <th class="text-center">관리</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:if="${#lists.isEmpty(tournaments)}">
                        <td colspan="8">
                            <div class="empty-state">
                                <i class="bi bi-inbox"></i>
                                <p class="fw-semibold">등록된 대회가 없습니다</p>
                                <a href="/tournament/create" class="btn btn-sm btn-primary">
                                    <i class="bi bi-plus-circle me-1"></i>첫 대회 등록하기
                                </a>
                            </div>
                        </td>
                    </tr>
                    <tr th:each="t : ${tournaments}">
                        <td><span class="text-muted small">#<span th:text="${t.id}"></span></span></td>
                        <td>
                            <a th:href="@{|/tournament/detail/${t.id}|}" class="fw-semibold text-decoration-none"
                               th:text="${t.title}">대회명</a>
                        </td>
                        <td class="text-muted small" th:text="${t.name}">주최</td>
                        <td><span class="type-badge" th:text="${t.type.description}">단식</span></td>
                        <td>
                            <div class="small text-muted">
                                <span th:text="${#temporals.format(t.startDate, 'yy.MM.dd')}">-</span>
                                ~ <span th:text="${#temporals.format(t.endDate, 'yy.MM.dd')}">-</span>
                            </div>
                        </td>
                        <td>
                            <form th:action="@{/admin/tournament/updateStatus/{id}(id=${t.id})}" method="post">
                                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                                <select name="status" class="status-select"
                                        th:data-current="${t.status.name()}"
                                        onchange="confirmStatusChange(this)">
                                    <option value="READY" th:selected="${t.status.name() == 'READY'}">준비중</option>
                                    <option value="RECRUITING" th:selected="${t.status.name() == 'RECRUITING'}">접수중</option>
                                    <option value="IN_PROGRESS" th:selected="${t.status.name() == 'IN_PROGRESS'}">진행중</option>
                                    <option value="MAIN_READY" th:selected="${t.status.name() == 'MAIN_READY'}">본선준비</option>
                                    <option value="COMPLETED" th:selected="${t.status.name() == 'COMPLETED'}">종료</option>
                                </select>
                            </form>
                        </td>
                        <td class="text-muted small" th:text="${t.creator != null ? t.creator.name : '-'}">-</td>
                        <td>
                            <div class="action-btns">
                                <a th:href="@{|/tournament/detail/${t.id}|}" class="btn-act btn-act-view" title="상세보기">
                                    <i class="bi bi-eye"></i>
                                </a>
                                <a th:href="@{|/tournament/edit/${t.id}|}" class="btn-act btn-act-edit" title="수정">
                                    <i class="bi bi-pencil"></i>
                                </a>
                                <button type="button" class="btn-act btn-act-del delete-btn" title="삭제"
                                        th:data-id="${t.id}" th:data-title="${t.title}">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>

    </div>

    <form id="deleteForm" method="post" style="display:none;">
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
    </form>

    <th:block layout:fragment="script">
    <script th:inline="javascript">
        function confirmStatusChange(sel) {
            const cur = sel.dataset.current, next = sel.value;
            if (cur === next) return;
            const names = { READY:'준비중', RECRUITING:'접수중', IN_PROGRESS:'진행중', MAIN_READY:'본선준비', COMPLETED:'종료' };
            if (confirm(`"${names[cur]}" → "${names[next]}" 로 변경하시겠습니까?`)) {
                sel.form.submit();
            } else {
                sel.value = cur;
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const id = this.dataset.id, title = this.dataset.title;
                    if (confirm(`"${title}" 대회를 삭제하시겠습니까?\n이 작업은 되돌릴 수 없습니다.`)) {
                        const form = document.getElementById('deleteForm');
                        form.action = '/admin/tournament/delete/' + id;
                        form.submit();
                    }
                });
            });

            const alert = document.getElementById('flashAlert');
            if (alert) setTimeout(() => { try { bootstrap.Alert.getOrCreateInstance(alert).close(); } catch(e) {} }, 5000);
        });
    </script>
    </th:block>
</div>
</body>
</html>
